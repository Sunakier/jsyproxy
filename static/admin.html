<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JsyProxy 管理后台</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-soft: #dbeafe;
            --bg-body: #f3f4f6;
            --bg-sidebar: #1f2937;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --bg-input: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --text-light: #f9fafb;
            --border: #e5e7eb;
            --border-strong: #cbd5e1;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --focus-ring: rgba(59, 130, 246, 0.25);
            --disabled-bg: #f1f5f9;
            --radius: 8px;
            --radius-sm: 6px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-focus: 0 0 0 4px var(--focus-ring);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #111827;
                --bg-sidebar: #0f172a;
                --bg-card: #1f2937;
                --bg-elevated: #111827;
                --bg-input: #1f2937;
                --text-main: #f9fafb;
                --text-muted: #9ca3af;
                --border: #374151;
                --border-strong: #4b5563;
                --primary-soft: rgba(59, 130, 246, 0.2);
                --focus-ring: rgba(59, 130, 246, 0.35);
                --disabled-bg: #111827;
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; }
        
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .text-muted { color: var(--text-muted); }
        
        .btn {
            padding: 0.56rem 1rem;
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: all 0.2s ease;
            font-size: 0.88rem;
            line-height: 1.15;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.12);
            user-select: none;
        }
        .btn:hover:not(:disabled) { transform: translateY(-1px); }
        .btn:active:not(:disabled) { transform: translateY(0); box-shadow: inset 0 1px 2px rgba(0,0,0,0.18); }
        .btn:focus-visible { outline: none; box-shadow: var(--shadow-focus); }
        .btn-primary {
            background: linear-gradient(180deg, var(--primary), var(--primary-hover));
            color: white;
        }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.04); }
        .btn-danger {
            background: linear-gradient(180deg, #f87171, var(--danger));
            color: white;
        }
        .btn-danger:hover:not(:disabled) { filter: brightness(1.05); }
        .btn-secondary {
            background: var(--bg-elevated);
            border-color: var(--border-strong);
            color: var(--text-main);
        }
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary-hover);
            background: var(--primary-soft);
        }
        .btn-sm { padding: 0.35rem 0.62rem; font-size: 0.79rem; }
        .btn:disabled {
            opacity: 0.58;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .input, .select {
            width: 100%;
            padding: 0.56rem 0.78rem;
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            color: var(--text-main);
            font-size: 0.9rem;
            line-height: 1.3;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .input:hover, .select:hover { border-color: var(--primary); }
        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow-focus);
            background: var(--bg-elevated);
        }
        .input::placeholder { color: #94a3b8; }
        @media (prefers-color-scheme: dark) {
            .input::placeholder { color: #64748b; }
        }
        .input:disabled, .select:disabled {
            background: var(--disabled-bg);
            color: var(--text-muted);
            cursor: not-allowed;
            border-color: var(--border);
        }

        select.input,
        .select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 2rem;
            background-image: linear-gradient(45deg, transparent 50%, var(--text-muted) 50%), linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
            background-position: calc(100% - 15px) calc(50% - 3px), calc(100% - 10px) calc(50% - 3px);
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
        }

        textarea.input {
            min-height: 92px;
            resize: vertical;
        }

        input[type='checkbox'],
        input[type='radio'] {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
            width: 1rem;
            height: 1rem;
            border: 1px solid var(--border-strong);
            background: var(--bg-input);
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.18s ease;
            position: relative;
            top: 0.04rem;
        }
        input[type='checkbox'] { border-radius: 0.28rem; }
        input[type='radio'] { border-radius: 50%; }
        input[type='checkbox']::before,
        input[type='radio']::before {
            content: '';
            width: 0.55rem;
            height: 0.55rem;
            transform: scale(0);
            transition: transform 0.15s ease;
        }
        input[type='checkbox']::before {
            clip-path: polygon(14% 44%, 0 61%, 45% 100%, 100% 16%, 84% 0, 43% 62%);
            background: #ffffff;
        }
        input[type='radio']::before {
            border-radius: 50%;
            background: #ffffff;
            width: 0.44rem;
            height: 0.44rem;
        }
        input[type='checkbox']:checked,
        input[type='radio']:checked {
            background: linear-gradient(180deg, var(--primary), var(--primary-hover));
            border-color: var(--primary-hover);
        }
        input[type='checkbox']:checked::before,
        input[type='radio']:checked::before {
            transform: scale(1);
        }
        input[type='checkbox']:hover,
        input[type='radio']:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        input[type='checkbox']:focus-visible,
        input[type='radio']:focus-visible {
            outline: none;
            box-shadow: var(--shadow-focus);
        }
        input[type='checkbox']:disabled,
        input[type='radio']:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        label { color: var(--text-main); }
        label > input[type='checkbox'],
        label > input[type='radio'] {
            margin-right: 0.4rem;
        }
        
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1rem; }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
        
        #login-view { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--bg-body); z-index: 100; }
        .login-box { width: 100%; max-width: 400px; }

        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: var(--bg-sidebar); color: var(--text-light); display: flex; flex-direction: column; padding: 1rem; position: fixed; top: 0; left: 0; bottom: 0; }
        .sidebar-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 2rem; padding: 0.5rem; }
        .nav-item { padding: 0.75rem 1rem; border-radius: var(--radius); cursor: pointer; margin-bottom: 0.25rem; color: #d1d5db; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        
        .main-content { flex: 1; margin-left: 240px; padding: 2rem; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .stat-label { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }

        .upstream-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
        .upstream-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .upstream-name { font-weight: 600; font-size: 1.1rem; }
        .upstream-detail { font-size: 0.875rem; color: var(--text-muted); line-height: 1.6; }
        .upstream-traffic { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .ua-cache-table-wrap { margin-top: 0.75rem; border-top: 1px solid var(--border); padding-top: 0.6rem; }
        .ua-cache-toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.55rem; }
        .ua-cache-toolbar .input { max-width: 220px; min-width: 160px; }
        .ua-cache-summary { font-size: 0.78rem; color: var(--text-muted); }
        .ua-cache-table-wrap .table-container {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: auto;
            max-height: 300px;
        }
        .ua-cache-table-wrap table { table-layout: fixed; min-width: 680px; }
        .ua-cache-table-wrap table th,
        .ua-cache-table-wrap table td { padding: 0.4rem 0.5rem; font-size: 0.78rem; vertical-align: top; }
        .ua-cache-table-wrap table th:nth-child(1),
        .ua-cache-table-wrap table td:nth-child(1) { width: 50%; }
        .ua-cache-table-wrap table th:nth-child(2),
        .ua-cache-table-wrap table td:nth-child(2) { width: 16%; }
        .ua-cache-table-wrap table th:nth-child(3),
        .ua-cache-table-wrap table td:nth-child(3) { width: 14%; }
        .ua-cache-table-wrap table th:nth-child(4),
        .ua-cache-table-wrap table td:nth-child(4) { width: 20%; }
        .ua-cache-ua-text {
            display: block;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: anywhere;
            line-height: 1.35;
            max-height: 5.4em;
            overflow-y: auto;
            padding-right: 0.2rem;
        }
        .ua-cache-meta { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.2rem; }
        .cache-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(440px, 1fr));
            gap: 1rem;
            margin-top: 0.75rem;
        }
        .cache-card .dash-card-header {
            align-items: flex-start;
            gap: 0.6rem;
            flex-wrap: wrap;
        }
        .cache-card-title-wrap { display: flex; flex-direction: column; gap: 0.35rem; }
        .cache-card-title-wrap .dash-card-title { line-height: 1.25; }
        .cache-summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }
        .cache-pill {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-body);
            padding: 0.55rem 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .cache-pill-label { font-size: 0.72rem; color: var(--text-muted); }
        .cache-pill-value { font-size: 0.88rem; color: var(--text-main); font-weight: 600; }
        .ua-toggle-row { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.45rem; }
        .ua-toggle-tip { font-size: 0.78rem; color: var(--text-muted); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
        th { font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }

        .badge { padding: 0.2rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--primary); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: var(--radius); box-shadow: var(--shadow); max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; }

        #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 0.75rem 1rem; border-radius: var(--radius); background: var(--bg-sidebar); color: white; font-size: 0.875rem; box-shadow: var(--shadow); animation: slideIn 0.3s ease; min-width: 200px; }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.success { border-left: 4px solid var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); z-index: 40; transition: transform 0.3s; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .menu-toggle { display: block !important; }
            .cache-grid { grid-template-columns: 1fr; gap: 0.8rem; }
            .cache-summary-row { grid-template-columns: 1fr 1fr; }
            .ua-cache-toolbar .input { max-width: 100%; min-width: 130px; }
        }

        /* Dashboard Card Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .dash-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .dash-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .dash-card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(59, 130, 246, 0.02), transparent);
        }

        .dash-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .dash-card-status {
            display: flex;
            gap: 0.5rem;
        }

        .dash-card-body {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .dash-info-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .dash-label { color: var(--text-muted); }
        .dash-value { font-weight: 500; color: var(--text-main); }
        .dash-value.sm { font-size: 0.85rem; }

        .traffic-bar-container {
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-body);
            border-radius: var(--radius);
        }
        
        .traffic-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        .traffic-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .traffic-bar-bg {
            height: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 99px;
            overflow: hidden;
        }
        :root[data-theme='dark'] .traffic-bar-bg { background: rgba(255,255,255,0.1); }

        .traffic-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 99px;
            transition: width 0.5s ease;
        }
        .traffic-bar-fill.warning { background: var(--warning); }
        .traffic-bar-fill.danger { background: var(--danger); }

        .dash-card-footer {
            padding: 0.75rem 1.25rem;
            background: var(--bg-body);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.4;
        }
        .tag-blue { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .tag-green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .tag-red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .tag-gray { background: rgba(107, 114, 128, 0.1); color: var(--text-muted); }
        .tag-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-success { background-color: var(--success); }
        .bg-danger { background-color: var(--danger); }
        .bg-warning { background-color: var(--warning); }
        .bg-info { background-color: var(--primary); }
        .dash-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            width: 100%;
            flex-wrap: wrap;
        }
        .code-box {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            background: var(--bg-body);
            padding: 0.35rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            word-break: break-all;
            border: 1px solid var(--border);
            color: var(--primary);
        }
        .dash-btn-group {
            display: flex;
            gap: 0.25rem;
        }
        .log-help {
            margin: 0 1.25rem 1rem;
            padding: 0.85rem 1rem;
            border: 1px dashed var(--border);
            border-radius: var(--radius);
            background: var(--bg-body);
            color: var(--text-muted);
            font-size: 0.82rem;
            line-height: 1.6;
        }
        .log-help strong { color: var(--text-main); }
        .log-ua {
            max-width: 360px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="login-view">
        <div class="card login-box">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">JsyProxy 管理后台</h2>
            <form id="login-form">
                <div class="form-group">
                    <input type="text" id="login-username" class="input" placeholder="用户名（默认 admin）">
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="input" placeholder="请输入密码" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">登录</button>
                <div id="login-error" class="text-danger text-sm mt-4" style="text-align: center;"></div>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden">
        <div class="app-container">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-title">JsyProxy</div>
                <nav id="nav-menu">
                    <div class="nav-item active" data-view="dashboard">概览</div>
                    <div class="nav-item" data-view="nodes">节点状态</div>
                    <div class="nav-item" data-view="cache">缓存状态</div>
                    <div class="nav-item" data-view="upstreams">上游管理</div>
                    <div class="nav-item" data-view="keys">Key管理</div>
                    <div class="nav-item" data-view="users">用户管理</div>
                    <div class="nav-item" data-view="logs">访问日志</div>
                    <div class="nav-item" data-view="settings">全局设置</div>
                </nav>
                <div style="margin-top: auto;">
                    <div id="current-user-meta" class="text-sm text-muted" style="padding: 0.75rem 1rem;"></div>
                    <div class="nav-item" id="logout-btn">退出登录</div>
                </div>
            </div>

            <div class="main-content">
                <div class="header">
                    <div class="flex items-center gap-4">
                        <button class="btn btn-secondary btn-sm menu-toggle" id="menu-toggle" style="display: none;">☰</button>
                        <h1 class="page-title" id="page-title">概览</h1>
                    </div>
                    <div id="header-actions" class="flex gap-2"></div>
                </div>
                <div id="content-area"></div>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script>
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        const PERM = {
            ADMIN_READ: 'admin.read',
            ADMIN_WRITE: 'admin.write',
            SETTINGS_WRITE: 'settings.write',
            UPSTREAM_READ: 'upstream.read',
            UPSTREAM_WRITE: 'upstream.write',
            KEY_READ: 'key.read',
            KEY_WRITE: 'key.write',
            LOG_READ: 'log.read',
            USER_MANAGE: 'user.manage'
        };

        const ROLE_PERMISSIONS = {
            super_admin: [PERM.ADMIN_READ, PERM.ADMIN_WRITE, PERM.SETTINGS_WRITE, PERM.UPSTREAM_READ, PERM.UPSTREAM_WRITE, PERM.KEY_READ, PERM.KEY_WRITE, PERM.LOG_READ, PERM.USER_MANAGE],
            operator: [PERM.ADMIN_READ, PERM.ADMIN_WRITE, PERM.SETTINGS_WRITE, PERM.UPSTREAM_READ, PERM.UPSTREAM_WRITE, PERM.KEY_READ, PERM.KEY_WRITE, PERM.LOG_READ],
            viewer: [PERM.ADMIN_READ, PERM.UPSTREAM_READ, PERM.KEY_READ, PERM.LOG_READ]
        };

        const VIEW_REQUIRED_PERMISSION = {
            dashboard: PERM.ADMIN_READ,
            nodes: PERM.UPSTREAM_READ,
            cache: PERM.UPSTREAM_READ,
            upstreams: PERM.UPSTREAM_READ,
            keys: PERM.KEY_READ,
            users: PERM.USER_MANAGE,
            logs: PERM.LOG_READ,
            settings: PERM.ADMIN_READ
        };

        const PERM_LABELS = {
            [PERM.ADMIN_READ]: '管理台概览读取',
            [PERM.ADMIN_WRITE]: '管理台刷新/写入操作',
            [PERM.SETTINGS_WRITE]: '全局设置修改',
            [PERM.UPSTREAM_READ]: '上游读取',
            [PERM.UPSTREAM_WRITE]: '上游写入/刷新/去重/删缓存',
            [PERM.KEY_READ]: 'Key读取',
            [PERM.KEY_WRITE]: 'Key写入',
            [PERM.LOG_READ]: '日志读取',
            [PERM.USER_MANAGE]: '用户管理'
        };

        const ROLE_DESCRIPTIONS = {
            super_admin: '超级管理员：默认拥有全部功能权限，可管理用户、权限与上游范围。',
            operator: '运维管理员：默认可管理上游、Key、设置与日志，不含用户管理。',
            viewer: '只读用户：默认仅可查看概览、上游、Key和日志，不可写操作。'
        };

        const state = {
            view: 'dashboard',
            logPage: 1,
            nodeStatusAutoTimers: [],
            nodesFocusUpstream: '',
            currentUser: null,
            permissions: new Set(),
            allPermissions: [],
            rolePermissions: { ...ROLE_PERMISSIONS },
            userScopeModes: ['all', 'selected'],
            userAssignableUpstreams: []
        };

        function normalizeRole(role) {
            return String(role || '').trim();
        }

        function setCurrentUser(user) {
            const role = normalizeRole(user?.role);
            const effectivePermissions = Array.isArray(user?.effective_permissions)
                ? user.effective_permissions
                : (ROLE_PERMISSIONS[role] || []);
            state.currentUser = {
                id: String(user?.id || '').trim(),
                username: String(user?.username || '').trim(),
                role,
                effective_permissions: effectivePermissions,
                custom_permissions: Array.isArray(user?.custom_permissions) ? user.custom_permissions : [],
                upstream_scope_mode: String(user?.upstream_scope_mode || 'all').trim(),
                upstream_scope_ids: Array.isArray(user?.upstream_scope_ids) ? user.upstream_scope_ids : []
            };
            state.permissions = new Set(effectivePermissions);
            syncCurrentUserMeta();
            applyNavigationPermissions();
        }

        function hasPermission(permission) {
            return state.permissions.has(permission);
        }

        function canView(view) {
            const required = VIEW_REQUIRED_PERMISSION[view];
            if (!required) return true;
            return hasPermission(required);
        }

        function firstAllowedView() {
            const preferredOrder = ['dashboard', 'upstreams', 'keys', 'logs'];
            for (const view of preferredOrder) {
                if (canView(view)) return view;
            }
            return 'dashboard';
        }

        function syncCurrentUserMeta() {
            const el = $('#current-user-meta');
            if (!el) return;
            if (!state.currentUser) {
                el.textContent = '';
                return;
            }
            const roleText = state.currentUser.role || '-';
            const username = state.currentUser.username || state.currentUser.id || '-';
            el.textContent = `${username} (${roleText})`;
        }

        function applyNavigationPermissions() {
            $$('.nav-item[data-view]').forEach(item => {
                const view = item.dataset.view;
                const allowed = canView(view);
                item.classList.toggle('hidden', !allowed);
            });
        }

        async function api(path, options = {}) {
            const res = await fetch('/admin/api' + path, {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...options.headers },
                ...options
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                if (res.status === 401) {
                    showLogin();
                }
                if (res.status === 403) {
                    throw new Error(data.error || '权限不足');
                }
                throw new Error(data.error || 'Request failed');
            }
            return data;
        }

        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.textContent = msg;
            $('#toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        function showLogin() {
            $('#login-view').classList.remove('hidden');
            $('#app-view').classList.add('hidden');
            state.currentUser = null;
            state.permissions = new Set();
            syncCurrentUserMeta();
            applyNavigationPermissions();
        }

        function showApp() {
            $('#login-view').classList.add('hidden');
            $('#app-view').classList.remove('hidden');
            navigate(firstAllowedView());
        }

        function clearNodeStatusAutoTimers() {
            if (!Array.isArray(state.nodeStatusAutoTimers)) {
                state.nodeStatusAutoTimers = [];
                return;
            }
            state.nodeStatusAutoTimers.forEach(t => {
                clearInterval(t);
            });
            state.nodeStatusAutoTimers = [];
        }

        function navigate(view) {
            if (!canView(view)) {
                showToast('当前账号无权访问该页面', 'error');
                view = firstAllowedView();
            }
            clearNodeStatusAutoTimers();
            state.view = view;
            $$('.nav-item[data-view]').forEach(n => {
                n.classList.toggle('active', n.dataset.view === view);
            });
            $('#header-actions').innerHTML = '';
            
            const titles = { dashboard: '概览', nodes: '节点状态', cache: '缓存状态', upstreams: '上游管理', keys: 'Key管理', users: '用户管理', logs: '访问日志', settings: '全局设置' };
            $('#page-title').textContent = titles[view] || view;

            switch(view) {
                case 'dashboard': renderDashboard(); break;
                case 'nodes': renderNodes(); break;
                case 'cache': renderCache(); break;
                case 'upstreams': renderUpstreams(); break;
                case 'keys': renderKeys(); break;
                case 'users': renderUsers(); break;
                case 'logs': renderLogs(); break;
                case 'settings': renderSettings(); break;
            }
        }

        async function renderDashboard() {
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';
            
            try {
                const data = await api('/status');
                if (data.current_user) {
                    setCurrentUser(data.current_user);
                }
                const canWriteUpstream = hasPermission(PERM.UPSTREAM_WRITE);
                
                let html = `
                    <div class="stats-grid">
                        <div class="card stat-card">
                            <div class="stat-value">${data.upstream_count || 0}</div>
                            <div class="stat-label">上游数量</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-value">${data.key_count || 0}</div>
                            <div class="stat-label">Key数量</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-value">${data.log_count || 0}</div>
                            <div class="stat-label">日志条数</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-value">${data.global_config?.active_ua_days || 30}</div>
                            <div class="stat-label">活跃UA窗口(天)</div>
                        </div>
                    </div>
                `;

                html += '<h3 class="mb-4">上游运行状态</h3><div class="dashboard-grid">';

                if (data.upstreams && data.upstreams.length > 0) {
                    data.upstreams.forEach(u => {
                        // Status & Configured Badges
                        const statusBadge = u.enabled
                            ? '<span class="tag tag-green"><span class="tag-dot bg-success"></span>启用</span>'
                            : '<span class="tag tag-red"><span class="tag-dot bg-danger"></span>禁用</span>';
                        
                        const configuredBadge = u.configured
                            ? '<span class="tag tag-blue"><span class="tag-dot bg-info"></span>已配置</span>'
                            : '<span class="tag tag-gray"><span class="tag-dot bg-warning"></span>未配置</span>';

                        // Node Status Logic (summary only + modal details)
                        let nodeStatusSection = '';
                        const nodeStatus = u.node_status || {};
                        const nodePanelId = `node-status-panel-${u.id}`;
                        if (nodeStatus.configured) {
                            nodeStatusSection = `
                                <div class="traffic-bar-container">
                                    <div class="traffic-header" style="align-items:center; gap:0.5rem;">
                                        <span>节点状态概览</span>
                                        <span class="text-sm text-muted">自动刷新: ${escapeHtml(u.node_status_refresh_interval || '10m')}</span>
                                    </div>
                                    <div id="${escapeHtml(nodePanelId)}">
                                        ${renderNodeStatusPanelHTML(nodeStatus)}
                                    </div>
                                    <div class="dash-actions" style="margin-top:0.6rem;">
                                        ${canWriteUpstream ? `<button class="btn btn-secondary btn-sm" data-node-investigate="${escapeHtml(u.id)}" data-node-panel="${escapeHtml(nodePanelId)}">调研拉取</button>` : ''}
                                        <button class="btn btn-primary btn-sm" data-node-jump="${escapeHtml(u.id)}">节点列表页</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            nodeStatusSection = `
                                <div class="traffic-bar-container" style="display:flex; justify-content:center; align-items:center; min-height: 58px; color: var(--text-muted); background: var(--bg-body);">
                                    <span style="font-size:0.82rem">未配置节点状态API</span>
                                </div>
                            `;
                        }

                        // Traffic Logic
                        let trafficSection = '';
                        let updatedTime = u.cache_updated_at 
                            ? new Date(u.cache_updated_at).toLocaleString() 
                            : '从未更新';

                        if (u.traffic) {
                            // Try to calculate percentage
                            const usedUp = parseFloat(u.traffic.used_upload) || 0;
                            const usedDown = parseFloat(u.traffic.used_download) || 0;
                            const total = parseFloat(u.traffic.transfer_enable) || 0;
                            const used = usedUp + usedDown;
                            
                            let pct = 0;
                            if (total > 0) {
                                pct = (used / total) * 100;
                                if (pct > 100) pct = 100;
                            }

                            // Progress Bar Color
                            let barClass = '';
                            if (pct >= 90) barClass = 'danger';
                            else if (pct >= 80) barClass = 'warning';

                            // Text Display
                            const usageText = u.traffic.usage_text || `${(used/1073741824).toFixed(2)}GB / ${(total/1073741824).toFixed(2)}GB`;
                            const expiryText = u.traffic.expiry_text || '长期有效';

                            trafficSection = `
                                <div class="traffic-bar-container">
                                    <div class="traffic-header">
                                        <span>${escapeHtml(u.traffic.plan_name || '套餐信息')}</span>
                                        <span>${pct.toFixed(1)}%</span>
                                    </div>
                                    <div class="traffic-bar-bg">
                                        <div class="traffic-bar-fill ${barClass}" style="width: ${pct}%"></div>
                                    </div>
                                    <div class="traffic-sub" style="display:flex; justify-content:space-between;">
                                        <span>${escapeHtml(usageText)}</span>
                                        <span>${escapeHtml(expiryText)}</span>
                                    </div>
                                </div>
                            `;
                        } else {
                             trafficSection = `
                                <div class="traffic-bar-container" style="display:flex; justify-content:center; align-items:center; min-height: 80px; color: var(--text-muted); background: var(--bg-body);">
                                    <span style="font-size:0.85rem">暂无流量数据</span>
                                </div>
                            `;
                        }

                        html += `
                            <div class="dash-card">
                                <div class="dash-card-header">
                                    <div class="dash-card-title">
                                        ${escapeHtml(u.name || '未命名')}
                                    </div>
                                    <div class="dash-card-status">
                                        ${statusBadge}
                                        ${configuredBadge}
                                    </div>
                                </div>
                                <div class="dash-card-body">
                                    <div class="dash-info-group">
                                        <span class="dash-label">缓存策略</span>
                                        <span class="dash-value sm">${u.cache_strategy === 'force' ? '强制' : '懒加载'}</span>
                                    </div>
                                    <div class="dash-info-group">
                                        <span class="dash-label">刷新周期</span>
                                        <span class="dash-value sm">${escapeHtml(u.refresh_interval || '10m')}</span>
                                    </div>
                                    <div class="dash-info-group">
                                        <span class="dash-label">缓存状态</span>
                                        <span class="dash-value sm">${u.has_cache ? '<span class="text-success">有效</span>' : '<span class="text-muted">无</span>'}</span>
                                    </div>
                                    <div class="dash-info-group">
                                        <span class="dash-label">变体数量</span>
                                        <span class="dash-value sm">${u.cache_variants || 0}</span>
                                    </div>
                                    ${nodeStatusSection}
                                    ${trafficSection}
                                </div>
                                <div class="dash-card-footer">
                                    <span>更新于 ${updatedTime}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="card text-muted">暂无上游配置，请先添加上游</div>';
                }

                html += '</div>';

                content.innerHTML = html;
                content.querySelectorAll('[data-node-investigate]').forEach(btn => {
                    btn.onclick = () => investigateNodeStatus(btn.dataset.nodeInvestigate, btn.dataset.nodePanel);
                });
                content.querySelectorAll('[data-node-jump]').forEach(btn => {
                    btn.onclick = () => openNodesTab(btn.dataset.nodeJump);
                });
                setupNodeStatusAutoRefresh(data.upstreams || []);
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        function renderNodeStatusPanelHTML(nodeStatus) {
            const totalNodes = parseInt(nodeStatus.total_nodes) || 0;
            const onlineNodes = parseInt(nodeStatus.online_nodes) || 0;
            const onlineRate = totalNodes > 0
                ? ((onlineNodes / totalNodes) * 100)
                : (parseFloat(nodeStatus.online_rate) || 0);
            const rateClamped = Math.max(0, Math.min(onlineRate, 100));
            const statusText = nodeStatus.fetch_error
                ? escapeHtml(nodeStatus.fetch_error)
                : (nodeStatus.is_refreshing ? '异步拉取中...' : (nodeStatus.has_cache ? '缓存可用' : '等待调研拉取'));
            const fetchedText = nodeStatus.fetched_at ? new Date(nodeStatus.fetched_at).toLocaleString() : '-';
            const expireText = nodeStatus.expires_at ? new Date(nodeStatus.expires_at).toLocaleString() : '-';

            return `
                <div class="traffic-header">
                    <span>${onlineNodes}/${totalNodes} (${onlineRate.toFixed(1)}%)</span>
                    <span>${nodeStatus.stale ? '缓存过期' : '缓存有效'}</span>
                </div>
                <div class="traffic-bar-bg">
                    <div class="traffic-bar-fill ${rateClamped < 50 ? 'danger' : (rateClamped < 80 ? 'warning' : '')}" style="width: ${rateClamped}%"></div>
                </div>
                <div class="traffic-sub" style="display:flex; justify-content:space-between;">
                    <span>${statusText}</span>
                    <span>更新: ${fetchedText}</span>
                </div>
                <div class="traffic-sub" style="display:flex; justify-content:space-between;">
                    <span>过期: ${expireText}</span>
                    <span>TTL: ${nodeStatus.cache_ttl_seconds || 600}s</span>
                </div>
            `;
        }

        async function investigateNodeStatus(upstreamID, panelID, options = {}) {
            if (!upstreamID || !panelID) return;
            const panel = document.getElementById(panelID);
            const forceRefresh = !!options.forceRefresh;
            const silent = !!options.silent;
            const canWriteUpstream = hasPermission(PERM.UPSTREAM_WRITE);

            let cachedData = null;
            try {
                cachedData = await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status');
                if (panel) panel.innerHTML = renderNodeStatusPanelHTML(cachedData);
            } catch (e) {
                // 如果首次读取缓存失败，继续尝试触发刷新
            }

            if (!forceRefresh && cachedData && cachedData.has_cache && !cachedData.stale) {
                const shouldForceRefresh = confirm('当前节点状态缓存仍在有效期内（10m）。是否强制刷新以获取最新状态？');
                if (!shouldForceRefresh) {
                    if (!silent) showToast('已展示有效缓存，未触发强制刷新', 'info');
                    return;
                }
            }

            if (!canWriteUpstream) {
                if (!silent) showToast('当前账号仅有只读权限，无法触发拉取', 'info');
                return;
            }

            try {
                await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status/refresh', { method: 'POST' });
                if (!silent) showToast('已触发异步拉取，正在轮询状态...', 'success');
            } catch (e) {
                if (!silent) showToast(e.message, 'error');
                return;
            }

            const maxPoll = 45;
            for (let i = 0; i < maxPoll; i++) {
                try {
                    const data = await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status');
                    if (panel) panel.innerHTML = renderNodeStatusPanelHTML(data);
                    if (!data.is_refreshing) {
                        if (!silent) showToast('节点状态拉取完成', 'success');
                        break;
                    }
                } catch (e) {
                    if (!silent) showToast(e.message, 'error');
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        function parseIntervalToMs(raw) {
            const value = String(raw || '10m').trim().toLowerCase();
            const match = value.match(/^(\d+)(ms|s|m|h)?$/);
            if (!match) return 10 * 60 * 1000;
            const num = parseInt(match[1], 10);
            const unit = match[2] || 's';
            if (unit === 'ms') return Math.max(1000, num);
            if (unit === 's') return Math.max(1000, num * 1000);
            if (unit === 'm') return Math.max(1000, num * 60 * 1000);
            if (unit === 'h') return Math.max(1000, num * 60 * 60 * 1000);
            return 10 * 60 * 1000;
        }

        function setupNodeStatusAutoRefresh(upstreams) {
            clearNodeStatusAutoTimers();
            upstreams.forEach(u => {
                const nodeStatus = u.node_status || {};
                if (!nodeStatus.configured) return;
                const panelID = `node-status-panel-${u.id}`;
                const intervalMs = parseIntervalToMs(u.node_status_refresh_interval || '10m');
                const timer = setInterval(() => {
                    if (state.view !== 'dashboard') return;
                    investigateNodeStatus(u.id, panelID, { forceRefresh: true, silent: true });
                }, intervalMs);
                state.nodeStatusAutoTimers.push(timer);
            });
        }

        function openNodesTab(upstreamID) {
            state.nodesFocusUpstream = String(upstreamID || '').trim();
            navigate('nodes');
        }


        async function loadUpstreamNodeStatus(upstream, options = {}) {
            const forceRefresh = !!options.forceRefresh;
            const upstreamID = upstream.id;
            let data = await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status');

            const needRefresh = forceRefresh || !data.has_cache || data.stale;
            if (needRefresh) {
                await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status/refresh', { method: 'POST' });
                for (let i = 0; i < 45; i++) {
                    data = await api('/upstreams/' + encodeURIComponent(upstreamID) + '/node-status');
                    if (!data.is_refreshing) break;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return data;
        }

        function flattenNodeRecords(entries) {
            return entries.flatMap(({ upstream, data, error }) => {
                if (error || !data || !Array.isArray(data.nodes)) return [];
                return data.nodes.map(n => ({
                    upstream_id: upstream.id || '',
                    upstream_name: upstream.name || '-',
                    id: n.id || '-',
                    name: n.name || '-',
                    type: n.type || '-',
                    host: n.host || '-',
                    rate: n.rate || '-',
                    is_online: !!n.is_online,
                    last_check_at: Number(n.last_check_at) || 0
                }));
            });
        }

        function sortNodeRecords(records, sortBy, sortOrder) {
            const factor = sortOrder === 'asc' ? 1 : -1;
            const sorted = [...records];
            sorted.sort((a, b) => {
                let av = a[sortBy];
                let bv = b[sortBy];

                if (sortBy === 'is_online') {
                    av = a.is_online ? 1 : 0;
                    bv = b.is_online ? 1 : 0;
                } else if (sortBy === 'last_check_at') {
                    av = Number(a.last_check_at) || 0;
                    bv = Number(b.last_check_at) || 0;
                } else if (sortBy === 'rate') {
                    av = parseFloat(String(a.rate).replace(/[^\d.\-]/g, '')) || 0;
                    bv = parseFloat(String(b.rate).replace(/[^\d.\-]/g, '')) || 0;
                } else {
                    av = String(av || '').toLowerCase();
                    bv = String(bv || '').toLowerCase();
                }

                if (av < bv) return -1 * factor;
                if (av > bv) return 1 * factor;
                return 0;
            });
            return sorted;
        }

        function renderNodeRowsHTML(records) {
            return records.map(n => {
                const onlineBadge = n.is_online
                    ? '<span class="tag tag-green">在线</span>'
                    : '<span class="tag tag-red">离线</span>';
                const checkAt = n.last_check_at > 0
                    ? new Date(n.last_check_at * 1000).toLocaleString()
                    : '-';
                return `
                    <tr>
                        <td>${escapeHtml(n.upstream_name)}</td>
                        <td>${escapeHtml(n.id)}</td>
                        <td>${escapeHtml(n.name)}</td>
                        <td>${escapeHtml(n.type)}</td>
                        <td>${escapeHtml(n.host)}</td>
                        <td>${escapeHtml(n.rate)}</td>
                        <td>${onlineBadge}</td>
                        <td>${escapeHtml(checkAt)}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderNodes(options = {}) {
            const forceRefresh = !!options.forceRefresh;
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载节点页面中...</div>';

            const canWriteUpstream = hasPermission(PERM.UPSTREAM_WRITE);

            $('#header-actions').innerHTML = canWriteUpstream
                ? `
                <button class="btn btn-secondary btn-sm" id="nodes-refresh-cache">刷新(优先缓存)</button>
                <button class="btn btn-primary btn-sm" id="nodes-refresh-force">强制全量拉取</button>
            `
                : '<span class="text-sm text-muted">当前为只读模式</span>';
            if (canWriteUpstream) {
            $('#nodes-refresh-cache').onclick = () => renderNodes({ forceRefresh: false });
            $('#nodes-refresh-force').onclick = () => renderNodes({ forceRefresh: true });
            }

            try {
                const statusData = await api('/status');
                const upstreams = (statusData.upstreams || []).filter(u => u.node_status_api_endpoint);

                if (upstreams.length === 0) {
                    content.innerHTML = '<div class="card text-muted">暂无配置节点状态API的上游，请先在上游管理中配置。</div>';
                    return;
                }

                const loadingCards = upstreams.map(u => `
                    <div class="dash-card">
                        <div class="dash-card-header"><div class="dash-card-title">${escapeHtml(u.name || '未命名')}</div></div>
                        <div class="dash-card-body"><span class="text-muted">正在拉取节点状态...</span></div>
                    </div>
                `).join('');

                const upstreamFilterOptions = ['<option value="">全部上游</option>']
                    .concat(upstreams.map(u => `<option value="${escapeHtml(u.id)}">${escapeHtml(u.name || '未命名')}</option>`))
                    .join('');

                content.innerHTML = `
                    <div class="stats-grid" style="margin-bottom: 1rem;" id="nodes-summary-grid"></div>
                    <div class="card" style="margin-bottom: 1rem; padding: 0.9rem;">
                        <div class="flex gap-2 items-center" style="flex-wrap: wrap;">
                            <select id="nodes-filter-upstream" class="input" style="max-width: 220px;">${upstreamFilterOptions}</select>
                            <input id="nodes-filter-keyword" class="input" style="max-width: 320px;" placeholder="搜索名称/Host/类型/ID">
                            <label style="display:flex; align-items:center; gap:0.4rem;"><input type="checkbox" id="nodes-filter-online"> 仅在线</label>
                            <select id="nodes-sort-by" class="input" style="max-width: 180px;">
                                <option value="upstream_name">按上游</option>
                                <option value="name">按名称</option>
                                <option value="host">按Host</option>
                                <option value="type">按类型</option>
                                <option value="rate">按倍率</option>
                                <option value="is_online">按状态</option>
                                <option value="last_check_at">按最后检测</option>
                            </select>
                            <select id="nodes-sort-order" class="input" style="max-width: 140px;">
                                <option value="asc">升序</option>
                                <option value="desc" selected>降序</option>
                            </select>
                            <select id="nodes-page-size" class="input" style="max-width: 140px;">
                                <option value="20">20/页</option>
                                <option value="50" selected>50/页</option>
                                <option value="100">100/页</option>
                                <option value="200">200/页</option>
                            </select>
                            <span class="text-sm text-muted">完整节点列表（支持上游过滤 / 搜索 / 排序 / 分页）</span>
                        </div>
                    </div>
                    <div class="dashboard-grid" id="nodes-upstream-cards">${loadingCards}</div>
                    <div class="table-container" style="margin-top: 1rem;">
                        <table>
                            <thead>
                                <tr><th>上游</th><th>ID</th><th>名称</th><th>类型</th><th>Host</th><th>倍率</th><th>状态</th><th>最后检测</th></tr>
                            </thead>
                            <tbody id="nodes-full-table-body">
                                <tr><td colspan="8" class="text-muted" style="text-align:center; padding:1rem;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex items-center justify-between" style="margin-top:0.75rem; gap:0.5rem; flex-wrap: wrap;">
                        <div id="nodes-page-info" class="text-sm text-muted">-</div>
                        <div class="dash-actions">
                            <button class="btn btn-secondary btn-sm" id="nodes-page-prev">上一页</button>
                            <button class="btn btn-secondary btn-sm" id="nodes-page-next">下一页</button>
                        </div>
                    </div>
                `;

                const entries = await Promise.all(upstreams.map(async upstream => {
                    try {
                        const data = await loadUpstreamNodeStatus(upstream, { forceRefresh: canWriteUpstream ? forceRefresh : false });
                        return { upstream, data, error: null };
                    } catch (e) {
                        return { upstream, data: null, error: e };
                    }
                }));

                const cardsHTML = entries.map(({ upstream, data, error }) => {
                    if (error) {
                        return `
                            <div class="dash-card">
                                <div class="dash-card-header"><div class="dash-card-title">${escapeHtml(upstream.name || '未命名')}</div></div>
                                <div class="dash-card-body"><span class="text-danger">拉取失败: ${escapeHtml(error.message || '未知错误')}</span></div>
                            </div>
                        `;
                    }
                    const total = parseInt(data.total_nodes) || 0;
                    const online = parseInt(data.online_nodes) || 0;
                    const rate = total > 0 ? (online * 100 / total) : 0;
                    return `
                        <div class="dash-card">
                            <div class="dash-card-header"><div class="dash-card-title">${escapeHtml(upstream.name || '未命名')}</div></div>
                            <div class="dash-card-body">
                                <div class="dash-info-group"><span class="dash-label">在线率</span><span class="dash-value sm">${online}/${total} (${rate.toFixed(1)}%)</span></div>
                                <div class="dash-info-group"><span class="dash-label">自动刷新</span><span class="dash-value sm">${escapeHtml(upstream.node_status_refresh_interval || '10m')}</span></div>
                                <div class="dash-info-group"><span class="dash-label">缓存状态</span><span class="dash-value sm">${data.stale ? '<span class="text-warning">过期</span>' : '<span class="text-success">有效</span>'}</span></div>
                            </div>
                        </div>
                    `;
                }).join('');
                $('#nodes-upstream-cards').innerHTML = cardsHTML;

                if (state.nodesFocusUpstream) {
                    const upstreamSelect = $('#nodes-filter-upstream');
                    if (upstreamSelect) {
                        upstreamSelect.value = state.nodesFocusUpstream;
                    }
                    state.nodesFocusUpstream = '';
                }

                let currentPage = 1;
                const buildTable = () => {
                    const upstreamID = $('#nodes-filter-upstream')?.value || '';
                    const keyword = $('#nodes-filter-keyword')?.value || '';
                    const onlyOnline = !!$('#nodes-filter-online')?.checked;
                    const sortBy = $('#nodes-sort-by')?.value || 'upstream_name';
                    const sortOrder = $('#nodes-sort-order')?.value || 'desc';
                    const pageSize = parseInt($('#nodes-page-size')?.value || '50', 10);
                    const kw = String(keyword).trim().toLowerCase();

                    let records = flattenNodeRecords(entries).filter(n => {
                        if (upstreamID && n.upstream_id !== upstreamID) return false;
                        if (onlyOnline && !n.is_online) return false;
                        if (!kw) return true;
                        const text = `${n.upstream_name} ${n.id} ${n.name} ${n.type} ${n.host}`.toLowerCase();
                        return text.includes(kw);
                    });

                    records = sortNodeRecords(records, sortBy, sortOrder);

                    const total = records.length;
                    const totalPages = Math.max(1, Math.ceil(total / pageSize));
                    if (currentPage > totalPages) currentPage = totalPages;
                    if (currentPage < 1) currentPage = 1;

                    const start = (currentPage - 1) * pageSize;
                    const pageRecords = records.slice(start, start + pageSize);

                    const onlineCount = records.filter(r => r.is_online).length;
                    const totalCount = records.length;
                    const onlineRate = totalCount > 0 ? (onlineCount * 100 / totalCount) : 0;
                    $('#nodes-summary-grid').innerHTML = `
                        <div class="card stat-card"><div class="stat-value">${totalCount}</div><div class="stat-label">筛选后节点总数</div></div>
                        <div class="card stat-card"><div class="stat-value">${onlineCount}</div><div class="stat-label">在线节点</div></div>
                        <div class="card stat-card"><div class="stat-value">${onlineRate.toFixed(1)}%</div><div class="stat-label">在线率</div></div>
                        <div class="card stat-card"><div class="stat-value">${upstreams.length}</div><div class="stat-label">上游数量</div></div>
                    `;

                    $('#nodes-full-table-body').innerHTML = pageRecords.length > 0
                        ? renderNodeRowsHTML(pageRecords)
                        : '<tr><td colspan="8" class="text-muted" style="text-align:center; padding:1rem;">无匹配节点</td></tr>';
                    $('#nodes-page-info').textContent = `共 ${total} 条，当前第 ${currentPage}/${totalPages} 页`;
                    $('#nodes-page-prev').disabled = currentPage <= 1;
                    $('#nodes-page-next').disabled = currentPage >= totalPages;
                };

                const resetAndBuild = () => {
                    currentPage = 1;
                    buildTable();
                };

                $('#nodes-filter-upstream').onchange = resetAndBuild;
                $('#nodes-filter-keyword').oninput = resetAndBuild;
                $('#nodes-filter-online').onchange = resetAndBuild;
                $('#nodes-sort-by').onchange = resetAndBuild;
                $('#nodes-sort-order').onchange = resetAndBuild;
                $('#nodes-page-size').onchange = resetAndBuild;
                $('#nodes-page-prev').onclick = () => {
                    currentPage -= 1;
                    buildTable();
                };
                $('#nodes-page-next').onclick = () => {
                    currentPage += 1;
                    buildTable();
                };

                buildTable();
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        function sortUACacheStatuses(statuses) {
            const list = Array.isArray(statuses) ? [...statuses] : [];
            list.sort((a, b) => {
                const reqA = Number(a?.total_requests || 0);
                const reqB = Number(b?.total_requests || 0);
                if (reqA !== reqB) return reqB - reqA;
                const seenA = a?.last_seen_at ? new Date(a.last_seen_at).getTime() : 0;
                const seenB = b?.last_seen_at ? new Date(b.last_seen_at).getTime() : 0;
                return seenB - seenA;
            });
            return list;
        }

        function renderCacheUARows(rows, upstreamID, canWriteUpstream) {
            return rows.map(item => {
                const uaText = item.is_default ? '默认UA' : (item.user_agent || '-');
                const uaDisplay = item.is_default
                    ? '<span class="tag tag-blue">默认UA</span>'
                    : `<span class="ua-cache-ua-text" title="${escapeHtml(uaText)}">${escapeHtml(uaText)}</span>`;

                const hasCacheBadge = item.has_cache
                    ? '<span class="tag tag-green">已缓存</span>'
                    : '<span class="tag tag-gray">未缓存</span>';

                const updatedTime = item.cache_updated_at
                    ? new Date(item.cache_updated_at).toLocaleString()
                    : '-';
                const lastSeenTime = item.last_seen_at
                    ? new Date(item.last_seen_at).toLocaleString()
                    : '-';

                const actionBtn = item.is_default
                    ? '<span class="text-sm text-muted">-</span>'
                    : (canWriteUpstream
                        ? `<button class="btn btn-danger btn-sm" data-cache-upstream="${escapeHtml(upstreamID)}" data-cache-ua="${escapeHtml(item.user_agent || '')}">删除</button>`
                        : '<span class="text-sm text-muted">只读</span>');

                return `
                    <tr>
                        <td>
                            <div>${uaDisplay}</div>
                            <div class="ua-cache-meta">更新: ${updatedTime}</div>
                            <div class="ua-cache-meta">最近访问: ${lastSeenTime}</div>
                        </td>
                        <td>${hasCacheBadge}</td>
                        <td>${item.total_requests || 0}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        function bindCacheDeleteButtons(root) {
            root.querySelectorAll('[data-cache-upstream]').forEach(btn => {
                btn.onclick = () => deleteUACacheVariant(btn.dataset.cacheUpstream, btn.dataset.cacheUa);
            });
        }

        function initCacheUATable(upstream, idx, canWriteUpstream) {
            const tableWrap = document.getElementById(`ua-cache-wrap-${idx}`);
            const tbody = document.getElementById(`ua-cache-body-${idx}`);
            const pageInfo = document.getElementById(`ua-cache-page-${idx}`);
            const prevBtn = document.getElementById(`ua-cache-prev-${idx}`);
            const nextBtn = document.getElementById(`ua-cache-next-${idx}`);
            const keywordInput = document.getElementById(`ua-cache-search-${idx}`);
            const pageSizeSelect = document.getElementById(`ua-cache-size-${idx}`);
            const onlyCachedInput = document.getElementById(`ua-cache-only-cached-${idx}`);
            const summary = document.getElementById(`ua-cache-summary-${idx}`);

            if (!tableWrap || !tbody || !pageInfo || !prevBtn || !nextBtn || !keywordInput || !pageSizeSelect || !onlyCachedInput || !summary) {
                return;
            }

            const source = sortUACacheStatuses(upstream.ua_cache_statuses || []);
            let currentPage = 1;

            const render = () => {
                const keyword = (keywordInput.value || '').trim().toLowerCase();
                const onlyCached = !!onlyCachedInput.checked;
                const pageSize = Math.max(1, parseInt(pageSizeSelect.value || '20', 10));

                const filtered = source.filter(item => {
                    if (onlyCached && !item.has_cache) return false;
                    if (!keyword) return true;
                    const ua = String(item.user_agent || '').toLowerCase();
                    const req = String(item.total_requests || 0);
                    return ua.includes(keyword) || req.includes(keyword);
                });

                const total = filtered.length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const start = (currentPage - 1) * pageSize;
                const pageRows = filtered.slice(start, start + pageSize);

                tbody.innerHTML = pageRows.length > 0
                    ? renderCacheUARows(pageRows, upstream.id, canWriteUpstream)
                    : '<tr><td colspan="4" class="text-muted" style="text-align:center; padding:0.85rem;">无匹配UA</td></tr>';

                summary.textContent = `总 ${source.length} 条，筛选后 ${total} 条`;
                pageInfo.textContent = `第 ${currentPage}/${totalPages} 页`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
                bindCacheDeleteButtons(tableWrap);
            };

            const resetAndRender = () => {
                currentPage = 1;
                render();
            };

            keywordInput.oninput = resetAndRender;
            pageSizeSelect.onchange = resetAndRender;
            onlyCachedInput.onchange = resetAndRender;
            prevBtn.onclick = () => {
                currentPage -= 1;
                render();
            };
            nextBtn.onclick = () => {
                currentPage += 1;
                render();
            };

            render();
        }

        async function renderCache() {
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';
            const canWriteUpstream = hasPermission(PERM.UPSTREAM_WRITE);
            
            try {
                const cacheData = await api('/cache-status');
                
                let html = `
                    <div class="flex justify-between items-center mb-4">
                        <h3>上游缓存详情</h3>
                        <button class="btn btn-secondary btn-sm" onclick="renderCache()">↻ 刷新</button>
                    </div>
                    <div class="card" style="padding: 0.85rem 1rem; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                        支持手动删除某个 UA 变体缓存。删除后会同时清理该 UA 的活跃刷新计划，避免被定时任务立即回填。
                    </div>
                    <div class="cache-grid">
                `;

                if (cacheData.upstreams && cacheData.upstreams.length > 0) {
                    cacheData.upstreams.forEach((u, idx) => {
                        const strategyText = u.cache_strategy === 'force' ? '强制缓存' : '懒缓存';
                        const statusBadge = u.enabled 
                            ? '<span class="tag tag-green"><span class="tag-dot bg-success"></span>启用</span>'
                            : '<span class="tag tag-red"><span class="tag-dot bg-danger"></span>禁用</span>';

                        const uaCount = Array.isArray(u.ua_cache_statuses) ? u.ua_cache_statuses.length : 0;
                        const defaultCount = (u.ua_cache_statuses || []).filter(item => item.is_default).length;
                        const cachedCount = (u.ua_cache_statuses || []).filter(item => item.has_cache).length;
                        const defaultPageSize = uaCount > 100 ? 50 : 20;
                        const collapsedByDefault = uaCount > 40;
                        const uaTableHtml = uaCount > 0
                            ? `
                                <div class="ua-cache-table-wrap" id="ua-cache-wrap-${idx}">
                                    <div class="ua-toggle-row">
                                        <div class="ua-toggle-tip">UA 变体列表（${uaCount}）</div>
                                        <button class="btn btn-secondary btn-sm" data-ua-toggle="${idx}" data-expanded="${collapsedByDefault ? '0' : '1'}">${collapsedByDefault ? '展开列表' : '收起列表'}</button>
                                    </div>
                                    <div id="ua-cache-panel-${idx}" style="display:${collapsedByDefault ? 'none' : 'block'};">
                                        <div class="ua-cache-toolbar">
                                            <input id="ua-cache-search-${idx}" class="input" placeholder="筛选UA / 请求数">
                                            <select id="ua-cache-size-${idx}" class="input" style="max-width: 130px;">
                                                <option value="20" ${defaultPageSize === 20 ? 'selected' : ''}>20/页</option>
                                                <option value="50" ${defaultPageSize === 50 ? 'selected' : ''}>50/页</option>
                                                <option value="100">100/页</option>
                                            </select>
                                            <label class="text-sm" style="display:flex; align-items:center; gap:0.35rem;">
                                                <input type="checkbox" id="ua-cache-only-cached-${idx}"> 仅已缓存
                                            </label>
                                            <span class="ua-cache-summary" id="ua-cache-summary-${idx}"></span>
                                        </div>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                    <tr><th>UA / 时间</th><th>状态</th><th>请求数</th><th>操作</th></tr>
                                                </thead>
                                                <tbody id="ua-cache-body-${idx}">
                                                    <tr><td colspan="4" class="text-muted" style="text-align:center; padding:0.85rem;">加载中...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="flex items-center justify-between" style="margin-top:0.45rem; gap:0.5rem; flex-wrap: wrap;">
                                            <span id="ua-cache-page-${idx}" class="text-sm text-muted">第 1/1 页</span>
                                            <div class="dash-actions">
                                                <button class="btn btn-secondary btn-sm" id="ua-cache-prev-${idx}">上一页</button>
                                                <button class="btn btn-secondary btn-sm" id="ua-cache-next-${idx}">下一页</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                              `
                            : '<div class="text-sm text-muted mt-4">暂无UA缓存统计</div>';

                        html += `
                            <div class="dash-card cache-card">
                                <div class="dash-card-header">
                                    <div class="cache-card-title-wrap">
                                        <div class="dash-card-title">${escapeHtml(u.name || '未命名')}</div>
                                        <div class="text-sm text-muted">更新于 ${u.cache_updated_at ? new Date(u.cache_updated_at).toLocaleString() : '从未更新'}</div>
                                    </div>
                                    <div class="dash-card-status">${statusBadge}</div>
                                </div>
                                <div class="dash-card-body">
                                    <div class="cache-summary-row">
                                        <div class="cache-pill">
                                            <span class="cache-pill-label">缓存策略</span>
                                            <span class="cache-pill-value">${strategyText}</span>
                                        </div>
                                        <div class="cache-pill">
                                            <span class="cache-pill-label">刷新周期</span>
                                            <span class="cache-pill-value">${escapeHtml(u.refresh_interval || '10m')}</span>
                                        </div>
                                        <div class="cache-pill">
                                            <span class="cache-pill-label">变体 / 已缓存</span>
                                            <span class="cache-pill-value">${u.cache_variants || 0} / ${cachedCount}</span>
                                        </div>
                                        <div class="cache-pill">
                                            <span class="cache-pill-label">默认UA</span>
                                            <span class="cache-pill-value">${defaultCount}</span>
                                        </div>
                                    </div>
                                    ${uaTableHtml}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="card text-muted">暂无上游配置</div>';
                }

                html += '</div>';
                content.innerHTML = html;
                bindCacheDeleteButtons(content);
                (cacheData.upstreams || []).forEach((u, idx) => {
                    initCacheUATable(u, idx, canWriteUpstream);
                });
                content.querySelectorAll('[data-ua-toggle]').forEach(btn => {
                    btn.onclick = () => {
                        const idx = btn.dataset.uaToggle;
                        const panel = document.getElementById(`ua-cache-panel-${idx}`);
                        if (!panel) return;
                        const expanded = btn.dataset.expanded === '1';
                        if (expanded) {
                            panel.style.display = 'none';
                            btn.dataset.expanded = '0';
                            btn.textContent = '展开列表';
                        } else {
                            panel.style.display = 'block';
                            btn.dataset.expanded = '1';
                            btn.textContent = '收起列表';
                        }
                    };
                });
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function deleteUACacheVariant(upstreamID, userAgent) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无删除权限', 'error');
                return;
            }
            if (!upstreamID || !userAgent) {
                showToast('缺少必要参数，无法删除UA缓存', 'error');
                return;
            }
            const shortUA = userAgent.length > 40 ? (userAgent.slice(0, 40) + '...') : userAgent;
            if (!confirm(`确定删除该UA缓存吗？\n${shortUA}`)) return;
            try {
                const result = await api('/upstreams/' + encodeURIComponent(upstreamID) + '/ua-cache?ua=' + encodeURIComponent(userAgent), { method: 'DELETE' });
                const removedCache = result.removed_cache ? '缓存已删' : '缓存不存在';
                const removedPlan = result.removed_plan ? '计划已清理' : '计划不存在';
                showToast(`删除完成：${removedCache}，${removedPlan}`, 'success');
                renderCache();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        let cachedUpstreamsList = [];

        async function renderUpstreams() {
            const actions = $('#header-actions');
            const canWriteUpstream = hasPermission(PERM.UPSTREAM_WRITE);
            actions.innerHTML = canWriteUpstream ? '<button class="btn btn-primary" id="add-upstream-btn">+ 添加上游</button>' : '<span class="text-sm text-muted">当前为只读模式</span>';
            if (canWriteUpstream) {
                $('#add-upstream-btn').onclick = () => openUpstreamModal();
            }

            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';

            try {
                const data = await api('/upstreams');
                cachedUpstreamsList = data.upstreams || [];

                if (cachedUpstreamsList.length === 0) {
                    content.innerHTML = '<div class="card text-muted">暂无上游，点击上方按钮添加</div>';
                    return;
                }

                let html = '<div class="dashboard-grid">';
                
                cachedUpstreamsList.forEach((u, idx) => {
                    const badge = u.enabled 
                        ? '<span class="tag tag-green"><span class="tag-dot bg-success"></span>启用</span>' 
                        : '<span class="tag tag-red"><span class="tag-dot bg-danger"></span>禁用</span>';
                    const upstreamType = (u.type || 'single') === 'merge' ? 'M类合并' : '普通';
                    const isMerge = (u.type || 'single') === 'merge';
                    const mergeConfig = (u && typeof u.merge_config === 'object' && u.merge_config) ? u.merge_config : {};
                    const mergeSources = Array.isArray(mergeConfig.sources) ? mergeConfig.sources : [];
                    const mergeInclude = Array.isArray(mergeConfig.include_name_contains) ? mergeConfig.include_name_contains : [];
                    const mergeExclude = Array.isArray(mergeConfig.exclude_name_contains) ? mergeConfig.exclude_name_contains : [];
                    const mergeReplacements = Array.isArray(mergeConfig.name_replacements) ? mergeConfig.name_replacements : [];
                    const mergeRules = Array.isArray(mergeConfig.rules) ? mergeConfig.rules : [];
                    const activeSourceCount = mergeSources.filter(s => s && s.enabled !== false).length;
                    const mergeDetailHtml = isMerge
                        ? `
                            <div class="dash-info-group">
                                <span class="dash-label">来源上游</span>
                                <span class="dash-value sm">${activeSourceCount} / ${mergeSources.length}</span>
                            </div>
                            <div class="dash-info-group">
                                <span class="dash-label">名称过滤</span>
                                <span class="dash-value sm">包含 ${mergeInclude.length} / 排除 ${mergeExclude.length}</span>
                            </div>
                            <div class="dash-info-group">
                                <span class="dash-label">名称替换</span>
                                <span class="dash-value sm">${mergeReplacements.length} 条</span>
                            </div>
                            <div class="dash-info-group">
                                <span class="dash-label">扩展规则</span>
                                <span class="dash-value sm">${mergeRules.length} 条</span>
                            </div>
                          `
                        : `
                            <div class="dash-info-group">
                                <span class="dash-label">API Endpoint</span>
                            </div>
                            <div class="code-box" style="margin-top: -0.5rem; margin-bottom: 0.5rem;">
                                ${escapeHtml(u.api_endpoint || '-')}
                            </div>
                            <div class="dash-info-group">
                                <span class="dash-label">节点状态API</span>
                            </div>
                            <div class="code-box" style="margin-top: -0.5rem; margin-bottom: 0.5rem;">
                                ${escapeHtml(u.node_status_api_endpoint || '-')}
                            </div>
                            <div class="dash-info-group">
                                <span class="dash-label">节点自动刷新</span>
                                <span class="dash-value sm">${escapeHtml(u.node_status_refresh_interval || '10m')}</span>
                            </div>
                          `;
                    const strategy = u.cache_strategy === 'force' ? '强制' : '懒加载';
                    const toggleStrategy = u.cache_strategy === 'force' ? 'lazy' : 'force';
                    const toggleLabel = u.cache_strategy === 'force' ? '切换为懒缓存' : '切换为强制';
                    const operationButtons = canWriteUpstream
                        ? `
                            <button class="btn btn-secondary btn-sm" data-up-refresh="${u.id}">刷新</button>
                            <button class="btn btn-secondary btn-sm" data-up-dedupe="${u.id}">去重</button>
                            <button class="btn btn-primary btn-sm" data-up-idx="${idx}">✎</button>
                            <button class="btn btn-danger btn-sm" data-up-del="${u.id}">🗑️</button>
                        `
                        : '<span class="text-sm text-muted">只读</span>';
                    
                    html += `
                        <div class="dash-card">
                            <div class="dash-card-header">
                                <div class="dash-card-title">${escapeHtml(u.name || '未命名')}</div>
                                ${badge}
                            </div>
                            <div class="dash-card-body">
                                <div class="dash-info-group">
                                    <span class="dash-label">类型</span>
                                    <span class="dash-value sm">${escapeHtml(upstreamType)}</span>
                                </div>
                                ${mergeDetailHtml}
                                
                                <div class="dash-info-group">
                                    <span class="dash-label">策略</span>
                                    <div class="dash-btn-group items-center">
                                        <span class="dash-value sm">${strategy}</span>
                                        ${canWriteUpstream ? `<button class="btn btn-secondary btn-sm" style="font-size: 0.7rem; padding: 2px 6px;" 
                                            data-up-toggle-strategy="${u.id}" 
                                            data-up-target-strategy="${toggleStrategy}"
                                            title="${toggleLabel}">⇄</button>` : ''}
                                    </div>
                                </div>

                                <div class="dash-info-group">
                                    <span class="dash-label">刷新周期</span>
                                    <span class="dash-value sm">${escapeHtml(u.refresh_interval || '10m')}</span>
                                </div>
                            </div>
                                <div class="dash-card-footer">
                                    <div class="dash-actions">
                                        ${operationButtons}
                                    </div>
                                </div>
                            </div>
                    `;
                });

                html += '</div>';
                content.innerHTML = html;

                if (canWriteUpstream) {
                    content.querySelectorAll('[data-up-refresh]').forEach(btn => {
                        btn.onclick = () => refreshUpstream(btn.dataset.upRefresh);
                    });
                    content.querySelectorAll('[data-up-dedupe]').forEach(btn => {
                        btn.onclick = () => dedupeUpstreamCache(btn.dataset.upDedupe);
                    });
                    content.querySelectorAll('[data-up-toggle-strategy]').forEach(btn => {
                        btn.onclick = () => switchCacheStrategy(btn.dataset.upToggleStrategy, btn.dataset.upTargetStrategy);
                    });
                    content.querySelectorAll('[data-up-idx]').forEach(btn => {
                        btn.onclick = () => {
                            const idx = parseInt(btn.dataset.upIdx);
                            openUpstreamModal(cachedUpstreamsList[idx]);
                        };
                    });
                    content.querySelectorAll('[data-up-del]').forEach(btn => {
                        btn.onclick = () => deleteUpstream(btn.dataset.upDel);
                    });
                }
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function switchCacheStrategy(id, newStrategy) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            try {
                // Find current upstream data to preserve other fields
                const upstream = cachedUpstreamsList.find(u => u.id === id);
                if (!upstream) throw new Error('上游未找到');
                
                const payload = { ...upstream, cache_strategy: newStrategy };
                
                await api('/upstreams/' + id, { method: 'PUT', body: JSON.stringify(payload) });
                showToast(`策略已切换为 ${newStrategy === 'force' ? '强制缓存' : '懒缓存'}`, 'success');
                renderUpstreams();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function refreshUpstream(id) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            try {
                await api('/upstreams/' + id + '/refresh', { method: 'POST' });
                showToast('刷新成功', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function dedupeUpstreamCache(id) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            try {
                const result = await api('/upstreams/' + id + '/dedupe', { method: 'POST' });
                showToast(`去重完成：移除 ${result.removed || 0} 个，剩余 ${result.remain || 0} 个`, 'success');
                renderUpstreams();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function deleteUpstream(id) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            if (!confirm('确定删除此上游？')) return;
            try {
                await api('/upstreams/' + id, { method: 'DELETE' });
                showToast('已删除', 'success');
                renderUpstreams();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function openUpstreamModal(data = null) {
            if (!hasPermission(PERM.UPSTREAM_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            const isEdit = !!data;
            const currentUpstreamID = String(data?.id || '').trim();
            const mergeDefaults = {
                sources: [],
                include_name_contains: [],
                exclude_name_contains: [],
                name_replacements: [],
                rules: []
            };
            const initialMergeConfig = normalizeMergeConfigForUI(data?.merge_config || mergeDefaults);
            const html = `
                <div class="form-group">
                    <label class="form-label">名称 *</label>
                    <input type="text" class="input" id="up-name" value="${escapeHtml(data?.name || '')}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">上游类型</label>
                    <select class="input" id="up-type">
                        <option value="single" ${(data?.type || 'single') === 'single' ? 'selected' : ''}>普通上游</option>
                        <option value="merge" ${(data?.type || 'single') === 'merge' ? 'selected' : ''}>M类上游（节点合并）</option>
                    </select>
                </div>

                <div id="single-upstream-fields">
                <div class="form-group">
                    <label class="form-label">API端点地址 *</label>
                    <input type="text" class="input" id="up-url" value="${escapeHtml(data?.api_endpoint || '')}" placeholder="https://...">
                    <div class="form-hint">普通上游必填；M类上游可留空（由来源上游聚合）。</div>
                </div>
                <div class="form-group">
                    <label class="form-label">M类配置（JSON）</label>
                    <textarea class="input" id="up-merge-config" rows="8" placeholder='{"sources":[{"upstream_id":"xxx","prefix":"JSY|","enabled":true}],"include_name_contains":[],"exclude_name_contains":[],"name_replacements":[{"from":"HKG","to":"HK"}],"rules":[]}'>${escapeHtml(JSON.stringify(data?.merge_config || { sources: [], include_name_contains: [], exclude_name_contains: [], name_replacements: [], rules: [] }, null, 2))}</textarea>
                    <div class="form-hint">仅M类上游生效。sources 中可配置每个来源上游前缀；支持名称包含/排除、名称替换与扩展规则。</div>
                </div>
                <div class="form-group">
                    <label class="form-label">节点状态API（可选）</label>
                    <input type="text" class="input" id="up-node-status-url" value="${escapeHtml(data?.node_status_api_endpoint || '')}" placeholder="https://.../api/v1/user/server/fetch">
                    <div class="form-hint">与上方API共用 Authorization / UA / Host / Origin / Referer / 自定义请求头，仅请求地址不同。</div>
                </div>
                <div class="form-group">
                    <label class="form-label">节点状态自动刷新周期</label>
                    <input type="text" class="input" id="up-node-status-interval" value="${escapeHtml(data?.node_status_refresh_interval || '10m')}" placeholder="10m / 5m / 30s">
                    <div class="form-hint">仅用于前端概览自动调研拉取，可单独配置，默认 10m。</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Authorization</label>
                    <input type="text" class="input" id="up-auth" value="${escapeHtml(data?.authorization || '')}">
                </div>
                <div class="form-group">
                    <label class="form-label">User-Agent</label>
                    <input type="text" class="input" id="up-ua" value="${escapeHtml(data?.request_user_agent || '')}">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Host</label>
                        <input type="text" class="input" id="up-host" value="${escapeHtml(data?.host || '')}">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Origin</label>
                        <input type="text" class="input" id="up-origin" value="${escapeHtml(data?.origin || '')}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Referer</label>
                    <input type="text" class="input" id="up-referer" value="${escapeHtml(data?.referer || '')}">
                </div>
                <div class="form-group">
                    <label class="form-label">自定义请求头</label>
                    <div id="custom-headers-list"></div>
                    <button type="button" class="btn btn-secondary btn-sm mt-4" id="add-header-btn">+ 添加请求头</button>
                    <div class="form-hint">添加额外的请求头，如 Cookie、X-Custom-Header 等。上方固定字段优先级更高。</div>
                </div>
                </div>

                <div id="merge-upstream-fields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">来源上游（GUI配置）</label>
                        <div id="merge-sources-list"></div>
                        <button type="button" class="btn btn-secondary btn-sm mt-4" id="add-merge-source-btn">+ 添加来源上游</button>
                        <div class="form-hint">仅可选择普通上游；M类上游与自身会自动隐藏，避免形成递归依赖。</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">名称包含（可选）</label>
                        <textarea class="input" id="merge-include-text" rows="2" placeholder="例如: HK,JP,US（逗号或换行分隔）">${escapeHtml((initialMergeConfig.include_name_contains || []).join('\n'))}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">名称排除（可选）</label>
                        <textarea class="input" id="merge-exclude-text" rows="2" placeholder="例如: TEST,EXPIRE（逗号或换行分隔）">${escapeHtml((initialMergeConfig.exclude_name_contains || []).join('\n'))}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">名称替换</label>
                        <div id="merge-replacements-list"></div>
                        <button type="button" class="btn btn-secondary btn-sm mt-4" id="add-merge-replacement-btn">+ 添加替换规则</button>
                        <div class="form-hint">示例：HKG → HK</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">扩展过滤规则</label>
                        <div id="merge-rules-list"></div>
                        <button type="button" class="btn btn-secondary btn-sm mt-4" id="add-merge-rule-btn">+ 添加规则</button>
                        <div class="form-hint">支持字段：name / protocol / host / port。操作：contains/not_contains/eq/ne/prefix/suffix/gt/lt/ge/le。</div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">刷新周期</label>
                        <input type="text" class="input" id="up-interval" value="${escapeHtml(data?.refresh_interval || '10m')}" placeholder="10m / 5m / 1h">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">缓存策略</label>
                        <select class="input" id="up-strategy">
                            <option value="force" ${data?.cache_strategy === 'force' ? 'selected' : ''}>强制缓存</option>
                            <option value="lazy" ${data?.cache_strategy === 'lazy' ? 'selected' : ''}>懒缓存</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="up-enabled" ${!data || data.enabled ? 'checked' : ''}> 启用</label>
                </div>
            `;

            showModal(isEdit ? '编辑上游' : '添加上游', html, async () => {
                const customHeaders = {};
                $$('#custom-headers-list .header-row').forEach(row => {
                    const key = row.querySelector('.header-key').value.trim();
                    const value = row.querySelector('.header-value').value.trim();
                    if (key && value) {
                        customHeaders[key] = value;
                    }
                });

                const payload = {
                    name: $('#up-name').value.trim(),
                    type: ($('#up-type')?.value || 'single').trim() || 'single',
                    api_endpoint: $('#up-url').value.trim(),
                    node_status_api_endpoint: $('#up-node-status-url').value.trim(),
                    node_status_refresh_interval: $('#up-node-status-interval').value.trim() || '10m',
                    authorization: $('#up-auth').value.trim(),
                    request_user_agent: $('#up-ua').value.trim(),
                    host: $('#up-host').value.trim(),
                    origin: $('#up-origin').value.trim(),
                    referer: $('#up-referer').value.trim(),
                    custom_headers: customHeaders,
                    refresh_interval: $('#up-interval').value.trim() || '10m',
                    cache_strategy: $('#up-strategy').value,
                    enabled: $('#up-enabled').checked
                };

                if (payload.type === 'merge') {
                    payload.merge_config = collectMergeConfigFromForm();
                } else {
                    payload.merge_config = mergeDefaults;
                }

                if (!payload.name) throw new Error('名称不能为空');
                if (payload.type === 'single' && !payload.api_endpoint) throw new Error('普通上游必须填写API端点地址');
                if (payload.type === 'merge' && (!payload.merge_config || !Array.isArray(payload.merge_config.sources) || payload.merge_config.sources.length === 0)) {
                    throw new Error('M类上游至少需要一个来源上游');
                }

                const url = isEdit ? '/upstreams/' + data.id : '/upstreams';
                const method = isEdit ? 'PUT' : 'POST';
                await api(url, { method, body: JSON.stringify(payload) });
                showToast('保存成功', 'success');
                renderUpstreams();
                return true;
            });

            // Initialize custom headers list after modal is shown
            initCustomHeadersList(data?.custom_headers || {});

            initMergeSourcesList(initialMergeConfig.sources, currentUpstreamID);
            initMergeReplacementsList(initialMergeConfig.name_replacements || []);
            initMergeRulesList(initialMergeConfig.rules || []);

            const typeSelect = $('#up-type');
            if (typeSelect) {
                typeSelect.onchange = () => toggleUpstreamTypeFields(typeSelect.value);
                toggleUpstreamTypeFields(typeSelect.value || 'single');
            }
        }

        function normalizeMergeConfigForUI(config) {
            const source = (config && typeof config === 'object') ? config : {};
            return {
                sources: Array.isArray(source.sources) ? source.sources : [],
                include_name_contains: Array.isArray(source.include_name_contains) ? source.include_name_contains : [],
                exclude_name_contains: Array.isArray(source.exclude_name_contains) ? source.exclude_name_contains : [],
                name_replacements: Array.isArray(source.name_replacements) ? source.name_replacements : [],
                rules: Array.isArray(source.rules) ? source.rules : []
            };
        }

        function toggleUpstreamTypeFields(type) {
            const isMerge = String(type || '').trim() === 'merge';
            const singleWrap = $('#single-upstream-fields');
            const mergeWrap = $('#merge-upstream-fields');
            if (singleWrap) singleWrap.classList.toggle('hidden', isMerge);
            if (mergeWrap) mergeWrap.classList.toggle('hidden', !isMerge);
        }

        function getMergeSourceCandidates(currentUpstreamID) {
            const currentID = String(currentUpstreamID || '').trim();
            return (cachedUpstreamsList || []).filter(item => {
                if (!item || !item.id) return false;
                if (item.id === currentID) return false;
                const type = String(item.type || 'single').trim();
                return type !== 'merge';
            });
        }

        function initMergeSourcesList(sources, currentUpstreamID) {
            const container = $('#merge-sources-list');
            if (!container) return;
            container.innerHTML = '';
            const normalized = Array.isArray(sources) ? sources : [];
            if (normalized.length === 0) {
                addMergeSourceRow(currentUpstreamID);
            } else {
                normalized.forEach(source => {
                    addMergeSourceRow(currentUpstreamID, source);
                });
            }
            const addBtn = $('#add-merge-source-btn');
            if (addBtn) {
                addBtn.onclick = () => addMergeSourceRow(currentUpstreamID);
            }
        }

        function addMergeSourceRow(currentUpstreamID, source = null) {
            const container = $('#merge-sources-list');
            if (!container) return;
            const candidates = getMergeSourceCandidates(currentUpstreamID);
            const selectedID = String(source?.upstream_id || '').trim();
            const selectedPrefix = String(source?.prefix || '').trim();
            const selectedEnabled = source?.enabled !== false;
            const hasSelectedInCandidates = candidates.some(item => item.id === selectedID);

            const row = document.createElement('div');
            row.className = 'merge-source-row flex gap-2 mb-4';
            row.style.alignItems = 'center';

            let optionsHtml = '<option value="">请选择来源上游</option>';
            candidates.forEach(item => {
                const selected = item.id === selectedID ? 'selected' : '';
                optionsHtml += `<option value="${escapeHtml(item.id)}" ${selected}>${escapeHtml(item.name || item.id)}</option>`;
            });
            if (selectedID && !hasSelectedInCandidates) {
                optionsHtml += `<option value="${escapeHtml(selectedID)}" selected>${escapeHtml(selectedID)}（不可用）</option>`;
            }

            row.innerHTML = `
                <select class="input merge-source-id" style="flex:2">${optionsHtml}</select>
                <input type="text" class="input merge-source-prefix" placeholder="前缀，如 JSY|" value="${escapeHtml(selectedPrefix)}" style="flex:1.5">
                <label class="text-sm" style="display:flex; align-items:center; gap:0.35rem; white-space:nowrap;"><input type="checkbox" class="merge-source-enabled" ${selectedEnabled ? 'checked' : ''}> 启用</label>
                <button type="button" class="btn btn-danger btn-sm merge-source-remove">&times;</button>
            `;
            row.querySelector('.merge-source-remove').onclick = () => row.remove();
            container.appendChild(row);
        }

        function initMergeReplacementsList(replacements) {
            const container = $('#merge-replacements-list');
            if (!container) return;
            container.innerHTML = '';
            const list = Array.isArray(replacements) ? replacements : [];
            if (list.length === 0) {
                addMergeReplacementRow();
            } else {
                list.forEach(item => {
                    addMergeReplacementRow(item);
                });
            }
            const addBtn = $('#add-merge-replacement-btn');
            if (addBtn) addBtn.onclick = () => addMergeReplacementRow();
        }

        function addMergeReplacementRow(item = null) {
            const container = $('#merge-replacements-list');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'merge-replace-row flex gap-2 mb-4';
            row.style.alignItems = 'center';
            row.innerHTML = `
                <input type="text" class="input merge-replace-from" placeholder="原字符" value="${escapeHtml(item?.from || '')}" style="flex:1">
                <span class="text-sm text-muted">→</span>
                <input type="text" class="input merge-replace-to" placeholder="替换为" value="${escapeHtml(item?.to || '')}" style="flex:1">
                <button type="button" class="btn btn-danger btn-sm merge-replace-remove">&times;</button>
            `;
            row.querySelector('.merge-replace-remove').onclick = () => row.remove();
            container.appendChild(row);
        }

        function initMergeRulesList(rules) {
            const container = $('#merge-rules-list');
            if (!container) return;
            container.innerHTML = '';
            const list = Array.isArray(rules) ? rules : [];
            if (list.length === 0) {
                addMergeRuleRow();
            } else {
                list.forEach(item => {
                    addMergeRuleRow(item);
                });
            }
            const addBtn = $('#add-merge-rule-btn');
            if (addBtn) addBtn.onclick = () => addMergeRuleRow();
        }

        function addMergeRuleRow(item = null) {
            const container = $('#merge-rules-list');
            if (!container) return;
            const field = String(item?.field || 'name').trim();
            const op = String(item?.op || 'contains').trim();
            const value = String(item?.value || '').trim();
            const fields = ['name', 'protocol', 'host', 'port'];
            const ops = ['contains', 'not_contains', 'eq', 'ne', 'prefix', 'suffix', 'gt', 'lt', 'ge', 'le'];
            const fieldOptions = fields.map(f => `<option value="${f}" ${f === field ? 'selected' : ''}>${f}</option>`).join('');
            const opOptions = ops.map(o => `<option value="${o}" ${o === op ? 'selected' : ''}>${o}</option>`).join('');

            const row = document.createElement('div');
            row.className = 'merge-rule-row flex gap-2 mb-4';
            row.style.alignItems = 'center';
            row.innerHTML = `
                <select class="input merge-rule-field" style="flex:1">${fieldOptions}</select>
                <select class="input merge-rule-op" style="flex:1.2">${opOptions}</select>
                <input type="text" class="input merge-rule-value" placeholder="规则值" value="${escapeHtml(value)}" style="flex:1.5">
                <button type="button" class="btn btn-danger btn-sm merge-rule-remove">&times;</button>
            `;
            row.querySelector('.merge-rule-remove').onclick = () => row.remove();
            container.appendChild(row);
        }

        function parseListText(raw) {
            return String(raw || '')
                .split(/[\n,]/)
                .map(item => item.trim())
                .filter(Boolean);
        }

        function collectMergeConfigFromForm() {
            const sources = [];
            $$('#merge-sources-list .merge-source-row').forEach(row => {
                const upstreamID = row.querySelector('.merge-source-id')?.value?.trim() || '';
                const prefix = row.querySelector('.merge-source-prefix')?.value?.trim() || '';
                const enabled = !!row.querySelector('.merge-source-enabled')?.checked;
                if (upstreamID) {
                    sources.push({ upstream_id: upstreamID, prefix, enabled });
                }
            });

            const nameReplacements = [];
            $$('#merge-replacements-list .merge-replace-row').forEach(row => {
                const from = row.querySelector('.merge-replace-from')?.value?.trim() || '';
                const to = row.querySelector('.merge-replace-to')?.value?.trim() || '';
                if (from) {
                    nameReplacements.push({ from, to });
                }
            });

            const rules = [];
            $$('#merge-rules-list .merge-rule-row').forEach(row => {
                const field = row.querySelector('.merge-rule-field')?.value?.trim() || '';
                const op = row.querySelector('.merge-rule-op')?.value?.trim() || '';
                const value = row.querySelector('.merge-rule-value')?.value?.trim() || '';
                if (field && op && value) {
                    rules.push({ field, op, value });
                }
            });

            return {
                sources,
                include_name_contains: parseListText($('#merge-include-text')?.value || ''),
                exclude_name_contains: parseListText($('#merge-exclude-text')?.value || ''),
                name_replacements: nameReplacements,
                rules
            };
        }

        let cachedUpstreams = [];
        let cachedKeys = [];
        let cachedUsers = [];

        async function renderKeys() {
            const actions = $('#header-actions');
            const canWriteKey = hasPermission(PERM.KEY_WRITE);
            actions.innerHTML = `
                <button class="btn btn-secondary" id="help-btn">使用说明</button>
                ${canWriteKey ? '<button class="btn btn-primary" id="add-key-btn">+ 添加Key</button>' : ''}
            `;
            if (canWriteKey) {
                $('#add-key-btn').onclick = () => openKeyModal();
            }
            $('#help-btn').onclick = () => showHelpModal();

            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';

            try {
                const [keysData, upstreamsData] = await Promise.all([
                    api('/keys'),
                    api('/upstreams')
                ]);
                cachedKeys = keysData.keys || [];
                cachedUpstreams = upstreamsData.upstreams || [];

                let html = `
                    <div class="dash-card" style="margin-bottom: 1.5rem;">
                        <div class="dash-card-body">
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <input type="text" class="input" id="base-url-input" placeholder="输入服务基础URL，如: http://localhost:3000" style="flex: 1; min-width: 250px;">
                                <button class="btn btn-secondary" id="show-usage-btn">📖 使用说明</button>
                            </div>
                        </div>
                    </div>
                `;

                if (cachedKeys.length === 0) {
                    html += '<div class="card text-muted">暂无Key，点击上方按钮添加</div>';
                } else {
                    html += '<div class="dashboard-grid">';
                    cachedKeys.forEach((k, idx) => {
                        const badge = k.enabled 
                            ? '<span class="tag tag-green"><span class="tag-dot bg-success"></span>启用</span>' 
                            : '<span class="tag tag-red"><span class="tag-dot bg-danger"></span>禁用</span>';
                        
                        const upstreamName = k.upstream_name || 
                                           cachedUpstreams.find(u => u.id === k.upstream_id)?.name || 
                                           k.upstream_id?.substring(0,8) || 
                                           '-';
                        const operationButtons = canWriteKey
                            ? `
                                <button class="btn btn-secondary btn-sm" data-copy-key="${k.key}" title="复制订阅链接">📋</button>
                                <button class="btn btn-primary btn-sm" data-key-idx="${idx}">✎</button>
                                <button class="btn btn-danger btn-sm" data-key-del="${k.id}">🗑️</button>
                            `
                            : `<button class="btn btn-secondary btn-sm" data-copy-key="${k.key}" title="复制订阅链接">📋</button>`;

                        html += `
                            <div class="dash-card">
                                <div class="dash-card-header">
                                    <div class="dash-card-title">${escapeHtml(k.name || '未命名')}</div>
                                    ${badge}
                                </div>
                                <div class="dash-card-body">
                                    <div class="dash-info-group">
                                        <span class="dash-label">Key</span>
                                    </div>
                                    <div class="code-box" style="margin-top: -0.5rem; margin-bottom: 0.5rem; cursor: pointer;" title="点击复制" onclick="navigator.clipboard.writeText('${k.key}'); showToast('已复制Key', 'success');">
                                        ${escapeHtml(k.key)}
                                    </div>
                                    <div class="dash-info-group">
                                        <span class="dash-label">绑定上游</span>
                                        <span class="dash-value sm">${escapeHtml(upstreamName)}</span>
                                    </div>
                                </div>
                                <div class="dash-card-footer">
                                    <div class="dash-actions">
                                        ${operationButtons}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                content.innerHTML = html;

                if (canWriteKey) {
                    content.querySelectorAll('[data-key-idx]').forEach(btn => {
                        btn.onclick = () => {
                            const idx = parseInt(btn.dataset.keyIdx);
                            openKeyModal(cachedKeys[idx]);
                        };
                    });
                    content.querySelectorAll('[data-key-del]').forEach(btn => {
                        btn.onclick = () => deleteKey(btn.dataset.keyDel);
                    });
                }
                content.querySelectorAll('[data-copy-key]').forEach(btn => {
                    btn.onclick = () => copySubscribeLink(btn.dataset.copyKey);
                });

                const showUsageBtn = $('#show-usage-btn');
                if (showUsageBtn) {
                    showUsageBtn.onclick = () => showHelpModal();
                }
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        function roleLabel(role) {
            if (role === 'super_admin') return '超级管理员';
            if (role === 'operator') return '运维管理员';
            if (role === 'viewer') return '只读用户';
            return role || '-';
        }

        async function renderUsers() {
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';
            const canManageUsers = hasPermission(PERM.USER_MANAGE);
            const actions = $('#header-actions');
            actions.innerHTML = canManageUsers
                ? '<button class="btn btn-primary" id="add-user-btn">+ 添加用户</button>'
                : '<span class="text-sm text-muted">当前账号无用户管理权限</span>';
            if (canManageUsers) {
                $('#add-user-btn').onclick = () => openUserModal();
            }

            try {
                const data = await api('/users');
                cachedUsers = data.users || [];
                state.allPermissions = Array.isArray(data.all_permissions) && data.all_permissions.length > 0
                    ? data.all_permissions
                    : Object.values(PERM);
                state.rolePermissions = data.role_permissions || { ...ROLE_PERMISSIONS };
                state.userScopeModes = Array.isArray(data.upstream_scope_modes) && data.upstream_scope_modes.length > 0
                    ? data.upstream_scope_modes
                    : ['all', 'selected'];
                state.userAssignableUpstreams = Array.isArray(data.upstreams) ? data.upstreams : [];
                if (cachedUsers.length === 0) {
                    content.innerHTML = '<div class="card text-muted">暂无用户</div>';
                    return;
                }

                const roleHelp = ['super_admin', 'operator', 'viewer'].map(role => {
                    const perms = state.rolePermissions[role] || ROLE_PERMISSIONS[role] || [];
                    const items = perms.map(p => `<span class="tag tag-blue">${escapeHtml(PERM_LABELS[p] || p)}</span>`).join(' ');
                    return `
                        <div style="margin-bottom:0.75rem;">
                            <div><strong>${escapeHtml(roleLabel(role))}</strong></div>
                            <div class="text-sm text-muted" style="margin:0.2rem 0 0.4rem;">${escapeHtml(ROLE_DESCRIPTIONS[role] || '')}</div>
                            <div style="display:flex; gap:0.3rem; flex-wrap:wrap;">${items || '<span class="text-sm text-muted">无默认权限</span>'}</div>
                        </div>
                    `;
                }).join('');

                let html = `
                    <div class="card" style="margin-bottom:1rem;">
                        <div class="card-title" style="margin-bottom:0.75rem;">预设角色权限说明</div>
                        <div class="text-sm text-muted" style="margin-bottom:0.75rem;">可在用户编辑时基于预设角色叠加“自定义功能权限”，并限制可访问的上游范围。</div>
                        ${roleHelp}
                    </div>
                    <div class="dash-card">
                        <div class="dash-card-header">
                            <div class="dash-card-title">管理员用户</div>
                        </div>
                        <div class="dash-card-body" style="padding:0;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr><th>用户名</th><th>角色</th><th>上游范围</th><th>自定义权限</th><th>状态</th><th>创建时间</th><th>更新时间</th><th>操作</th></tr>
                                    </thead>
                                    <tbody>
                `;

                cachedUsers.forEach((u, idx) => {
                    const statusText = u.enabled ? '<span class="tag tag-green">启用</span>' : '<span class="tag tag-red">禁用</span>';
                    const isCurrentUser = state.currentUser && state.currentUser.id === u.id;
                    const scopeText = u.upstream_scope_mode === 'selected'
                        ? `指定(${(u.upstream_scope_ids || []).length})`
                        : '全部上游';
                    const customPerms = Array.isArray(u.custom_permissions) ? u.custom_permissions : [];
                    const customPermText = customPerms.length > 0
                        ? customPerms.map(p => PERM_LABELS[p] || p).join('、')
                        : '-';
                    const operationButtons = canManageUsers
                        ? `
                            <button class="btn btn-primary btn-sm" data-user-edit="${idx}">编辑</button>
                            <button class="btn btn-secondary btn-sm" data-user-password="${u.id}">改密</button>
                            <button class="btn btn-danger btn-sm" data-user-delete="${u.id}" ${isCurrentUser ? 'disabled' : ''}>删除</button>
                          `
                        : '<span class="text-sm text-muted">-</span>';
                    html += `
                        <tr>
                            <td>${escapeHtml(u.username || '-')} ${isCurrentUser ? '<span class="tag tag-blue">当前</span>' : ''}</td>
                            <td>${escapeHtml(roleLabel(u.role))}</td>
                            <td class="text-sm">${escapeHtml(scopeText)}</td>
                            <td class="text-sm" title="${escapeHtml(customPermText)}">${escapeHtml(customPermText.length > 32 ? customPermText.slice(0, 32) + '...' : customPermText)}</td>
                            <td>${statusText}</td>
                            <td>${u.created_at ? new Date(u.created_at).toLocaleString() : '-'}</td>
                            <td>${u.updated_at ? new Date(u.updated_at).toLocaleString() : '-'}</td>
                            <td><div class="dash-actions">${operationButtons}</div></td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div></div></div>';
                content.innerHTML = html;

                if (canManageUsers) {
                    content.querySelectorAll('[data-user-edit]').forEach(btn => {
                        btn.onclick = () => {
                            const idx = parseInt(btn.dataset.userEdit, 10);
                            openUserModal(cachedUsers[idx]);
                        };
                    });
                    content.querySelectorAll('[data-user-password]').forEach(btn => {
                        btn.onclick = () => openUserPasswordModal(btn.dataset.userPassword);
                    });
                    content.querySelectorAll('[data-user-delete]').forEach(btn => {
                        btn.onclick = () => deleteUser(btn.dataset.userDelete);
                    });
                }
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        function openUserModal(data = null) {
            if (!hasPermission(PERM.USER_MANAGE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            const isEdit = !!data;
            const rolePerms = state.rolePermissions || { ...ROLE_PERMISSIONS };
            const selectedCustomPerms = new Set(Array.isArray(data?.custom_permissions) ? data.custom_permissions : []);
            const selectedScopeMode = String(data?.upstream_scope_mode || 'all').trim() || 'all';
            const selectedScopeIDs = new Set(Array.isArray(data?.upstream_scope_ids) ? data.upstream_scope_ids : []);
            const permissionOptions = (state.allPermissions || Object.values(PERM)).map(permission => {
                const checked = selectedCustomPerms.has(permission) ? 'checked' : '';
                return `<label style="display:flex; align-items:center; gap:0.45rem; margin-bottom:0.35rem;"><input type="checkbox" class="user-custom-permission" value="${escapeHtml(permission)}" ${checked}> <span>${escapeHtml(PERM_LABELS[permission] || permission)}</span></label>`;
            }).join('');

            const upstreamOptions = (state.userAssignableUpstreams || []).map(upstream => {
                const checked = selectedScopeIDs.has(upstream.id) ? 'checked' : '';
                return `<label style="display:flex; align-items:center; gap:0.45rem; margin-bottom:0.35rem;"><input type="checkbox" class="user-upstream-id" value="${escapeHtml(upstream.id)}" ${checked}> <span>${escapeHtml(upstream.name || upstream.id)}</span></label>`;
            }).join('');

            const html = `
                <div class="form-group">
                    <label class="form-label">用户名 *</label>
                    <input type="text" class="input" id="user-username" value="${escapeHtml(data?.username || '')}" required>
                </div>
                ${isEdit ? '' : `<div class="form-group"><label class="form-label">密码 *</label><input type="password" class="input" id="user-password" required></div>`}
                <div class="form-group">
                    <label class="form-label">角色 *</label>
                    <select class="input" id="user-role">
                        <option value="super_admin" ${data?.role === 'super_admin' ? 'selected' : ''}>超级管理员</option>
                        <option value="operator" ${data?.role === 'operator' ? 'selected' : ''}>运维管理员</option>
                        <option value="viewer" ${data?.role === 'viewer' ? 'selected' : ''}>只读用户</option>
                    </select>
                    <div class="form-hint" id="user-role-perms-hint"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">自定义功能权限（在角色默认权限基础上叠加）</label>
                    <div style="max-height:200px; overflow:auto; border:1px solid var(--border); border-radius: var(--radius); padding:0.6rem;">${permissionOptions || '<span class="text-sm text-muted">无可配置权限</span>'}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">上游访问范围</label>
                    <select class="input" id="user-scope-mode">
                        <option value="all" ${selectedScopeMode === 'all' ? 'selected' : ''}>全部上游</option>
                        <option value="selected" ${selectedScopeMode === 'selected' ? 'selected' : ''}>指定上游</option>
                    </select>
                    <div class="form-hint">选择“指定上游”后，仅允许访问勾选的上游。</div>
                </div>
                <div class="form-group" id="user-scope-upstreams-wrap">
                    <label class="form-label">可访问上游</label>
                    <div style="max-height:180px; overflow:auto; border:1px solid var(--border); border-radius: var(--radius); padding:0.6rem;">${upstreamOptions || '<span class="text-sm text-muted">暂无可选上游</span>'}</div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="user-enabled" ${!data || data.enabled ? 'checked' : ''}> 启用</label>
                </div>
            `;

            showModal(isEdit ? '编辑用户' : '添加用户', html, async () => {
                const username = ($('#user-username')?.value || '').trim();
                const role = $('#user-role')?.value || 'viewer';
                const enabled = !!$('#user-enabled')?.checked;
                const customPermissions = Array.from($$('.user-custom-permission')).filter(el => el.checked).map(el => el.value);
                const upstreamScopeMode = ($('#user-scope-mode')?.value || 'all').trim();
                const upstreamScopeIDs = Array.from($$('.user-upstream-id')).filter(el => el.checked).map(el => el.value);
                if (!username) throw new Error('用户名不能为空');
                if (upstreamScopeMode === 'selected' && upstreamScopeIDs.length === 0) {
                    throw new Error('请选择至少一个可访问上游');
                }

                if (isEdit) {
                    await api('/users/' + encodeURIComponent(data.id), {
                        method: 'PUT',
                        body: JSON.stringify({ username, role, enabled, custom_permissions: customPermissions, upstream_scope_mode: upstreamScopeMode, upstream_scope_ids: upstreamScopeIDs })
                    });
                } else {
                    const password = ($('#user-password')?.value || '').trim();
                    if (!password) throw new Error('密码不能为空');
                    await api('/users', {
                        method: 'POST',
                        body: JSON.stringify({ username, password, role, custom_permissions: customPermissions, upstream_scope_mode: upstreamScopeMode, upstream_scope_ids: upstreamScopeIDs })
                    });
                }
                showToast('保存成功', 'success');
                renderUsers();
                return true;
            });

            const syncRoleHint = () => {
                const role = $('#user-role')?.value || 'viewer';
                const perms = rolePerms[role] || ROLE_PERMISSIONS[role] || [];
                const text = perms.length > 0
                    ? `角色默认权限：${perms.map(p => PERM_LABELS[p] || p).join('、')}`
                    : '角色默认无权限';
                const hint = $('#user-role-perms-hint');
                if (hint) hint.textContent = text;
            };
            const syncScopeVisibility = () => {
                const mode = $('#user-scope-mode')?.value || 'all';
                const wrap = $('#user-scope-upstreams-wrap');
                if (!wrap) return;
                wrap.style.display = mode === 'selected' ? 'block' : 'none';
            };
            const roleInput = $('#user-role');
            if (roleInput) roleInput.onchange = syncRoleHint;
            const scopeModeInput = $('#user-scope-mode');
            if (scopeModeInput) scopeModeInput.onchange = syncScopeVisibility;
            syncRoleHint();
            syncScopeVisibility();
        }

        function openUserPasswordModal(userID) {
            if (!hasPermission(PERM.USER_MANAGE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            showModal('重置用户密码', `
                <div class="form-group">
                    <label class="form-label">新密码 *</label>
                    <input type="password" class="input" id="user-new-password" required>
                </div>
            `, async () => {
                const password = ($('#user-new-password')?.value || '').trim();
                if (!password) throw new Error('密码不能为空');
                await api('/users/' + encodeURIComponent(userID) + '/password', {
                    method: 'PUT',
                    body: JSON.stringify({ password })
                });
                showToast('密码已更新', 'success');
                return true;
            });
        }

        async function deleteUser(userID) {
            if (!hasPermission(PERM.USER_MANAGE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            if (!userID) return;
            if (!confirm('确定删除该用户？')) return;
            try {
                await api('/users/' + encodeURIComponent(userID), { method: 'DELETE' });
                showToast('用户已删除', 'success');
                renderUsers();
            } catch (e) {
                showToast(e.message || '删除失败', 'error');
            }
        }

        async function deleteKey(id) {
            if (!hasPermission(PERM.KEY_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            if (!confirm('确定删除此Key？')) return;
            try {
                await api('/keys/' + id, { method: 'DELETE' });
                showToast('已删除', 'success');
                renderKeys();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function openKeyModal(data = null) {
            if (!hasPermission(PERM.KEY_WRITE)) {
                showToast('当前账号无操作权限', 'error');
                return;
            }
            const isEdit = !!data;
            let optionsHtml = '<option value="">-- 请选择 --</option>';
            cachedUpstreams.forEach(u => {
                optionsHtml += `<option value="${u.id}" ${data?.upstream_id === u.id ? 'selected' : ''}>${escapeHtml(u.name)}</option>`;
            });

            const html = `
                <div class="form-group">
                    <label class="form-label">Key *</label>
                    <input type="text" class="input" id="key-token" value="${escapeHtml(data?.key || '')}" ${isEdit ? 'disabled' : ''} placeholder="留空自动生成">
                    ${isEdit ? '<div class="form-hint">Key创建后不可修改</div>' : ''}
                </div>
                <div class="form-group">
                    <label class="form-label">名称/备注</label>
                    <input type="text" class="input" id="key-name" value="${escapeHtml(data?.name || '')}">
                </div>
                <div class="form-group">
                    <label class="form-label">绑定上游 *</label>
                    <select class="input" id="key-upstream">${optionsHtml}</select>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="key-enabled" ${!data || data.enabled ? 'checked' : ''}> 启用</label>
                </div>
            `;

            showModal(isEdit ? '编辑Key' : '添加Key', html, async () => {
                const payload = {
                    name: $('#key-name').value.trim(),
                    upstream_id: $('#key-upstream').value,
                    enabled: $('#key-enabled').checked
                };

                if (!isEdit) {
                    payload.key = $('#key-token').value.trim() || generateKey();
                }

                if (!payload.upstream_id) throw new Error('请选择上游');

                const url = isEdit ? '/keys/' + data.id : '/keys';
                const method = isEdit ? 'PUT' : 'POST';
                await api(url, { method, body: JSON.stringify(payload) });
                showToast('保存成功', 'success');
                renderKeys();
                return true;
            });
        }

        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function getBaseUrl() {
            // 优先使用用户输入的URL，否则使用当前页面URL
            const input = $('#base-url-input');
            if (input && input.value.trim()) {
                return input.value.trim().replace(/\/$/, '');
            }
            // 使用当前页面的 origin
            return window.location.origin;
        }

        async function copySubscribeLink(key) {
            const baseUrl = getBaseUrl();
            const link = `${baseUrl}/apix/getSubscribe?token=${key}`;

            try {
                await navigator.clipboard.writeText(link);
                showToast('订阅链接已复制到剪贴板', 'success');
            } catch (err) {
                // 降级方案：创建临时textarea
                const textarea = document.createElement('textarea');
                textarea.value = link;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('订阅链接已复制到剪贴板', 'success');
                } catch (e) {
                    showToast('复制失败，请手动复制: ' + link, 'error');
                }
                document.body.removeChild(textarea);
            }
        }

        function showHelpModal() {
            const baseUrl = getBaseUrl();
            const html = `
                <div class="form-group">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">📖 使用方法</h3>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">1. 获取订阅链接</h4>
                        <p class="text-sm text-muted" style="margin-bottom: 0.5rem;">
                            在 Key 管理页面，点击对应 Key 的「📋 复制链接」按钮，即可复制完整的订阅链接。
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">2. 在客户端中使用</h4>
                        <p class="text-sm text-muted" style="margin-bottom: 0.5rem;">
                            将复制的订阅链接粘贴到以下任一客户端的订阅设置中：
                        </p>
                        <ul class="text-sm" style="margin-left: 1.5rem; color: var(--text-muted);">
                            <li>Clash / Clash Verge / Clash Meta</li>
                            <li>Shadowrocket (小火箭)</li>
                            <li>Quantumult X</li>
                            <li>Surfboard</li>
                            <li>V2Ray / V2RayNG / V2RayN</li>
                            <li>Surge</li>
                            <li>其他支持标准订阅链接的客户端</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">3. 订阅链接格式</h4>
                        <div style="background: var(--bg-body); padding: 1rem; border-radius: var(--radius); font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                            ${baseUrl}/apix/getSubscribe?token=<span style="color: var(--primary);">YOUR_KEY</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">4. 注意事项</h4>
                        <ul class="text-sm" style="margin-left: 1.5rem; color: var(--text-muted);">
                            <li>请妥善保管您的订阅链接，避免泄露给他人</li>
                            <li>如果怀疑链接泄露，请及时更换 Key</li>
                            <li>上游缓存会定期自动刷新，无需手动更新订阅</li>
                            <li>每个 Key 绑定一个上游，可以在 Key 管理中查看</li>
                        </ul>
                    </div>
                </div>
            `;

            showModal('使用说明', html, async () => true);
        }

        function initCustomHeadersList(headers) {
            const container = $('#custom-headers-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Add existing headers
            if (headers && typeof headers === 'object') {
                Object.entries(headers).forEach(([key, value]) => {
                    addHeaderRow(key, value);
                });
            }
            
            // Bind add button
            const addBtn = $('#add-header-btn');
            if (addBtn) {
                addBtn.onclick = () => addHeaderRow('', '');
            }
        }

        function addHeaderRow(key = '', value = '') {
            const container = $('#custom-headers-list');
            if (!container) return;
            
            const row = document.createElement('div');
            row.className = 'header-row flex gap-2 mb-4';
            row.style.alignItems = 'center';
            row.innerHTML = `
                <input type="text" class="input header-key" placeholder="Header名称" value="${escapeHtml(key)}" style="flex:1">
                <input type="text" class="input header-value" placeholder="Header值" value="${escapeHtml(value)}" style="flex:2">
                <button type="button" class="btn btn-danger btn-sm header-remove">&times;</button>
            `;
            
            row.querySelector('.header-remove').onclick = () => row.remove();
            container.appendChild(row);
        }

        async function renderLogs() {
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';
            await loadLogPage(1);
        }

        async function loadLogPage(page) {
            state.logPage = page;
            const content = $('#content-area');
            
            try {
                const data = await api('/logs?page=' + page + '&page_size=50');
                const logs = data.logs || [];
                
                let html = `
                    <div class="dash-card">
                        <div class="dash-card-header">
                            <div class="dash-card-title">访问日志</div>
                        </div>
                        <div class="log-help">
                            <div><strong>说明：</strong>每条日志记录一次客户端拉取请求，包含 <strong>原始UA</strong>、<strong>命中规则(ua_rule)</strong>、<strong>变体(ua_variant)</strong>、<strong>家族/缓存桶(ua_family)</strong>。</div>
                            <div>规则与家族来自「全局设置 → UA归一化规则」。家族一致表示会命中同一缓存变体。</div>
                        </div>
                        <div class="dash-card-body" style="padding:0;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr><th>时间</th><th>Key</th><th>IP</th><th>客户端UA</th><th>命中规则</th><th>变体</th><th>家族</th><th>缓存</th><th>结果</th><th>备注</th></tr>
                                    </thead>
                                    <tbody>
                `;
                
                if (logs.length === 0) {
                    html += '<tr><td colspan="10" class="text-muted" style="text-align:center; padding: 2rem;">暂无访问日志</td></tr>';
                } else {
                    logs.forEach(l => {
                        const cacheHit = l.cache_hit 
                            ? '<span class="tag tag-green">HIT</span>' 
                            : '<span class="tag tag-gray">MISS</span>';
                        const statusBadge = l.status === 'success' 
                            ? '<span class="tag tag-green">成功</span>' 
                            : '<span class="tag tag-red">失败</span>';
                        const keyDisplay = l.key_name || l.key || '-';
                        const ruleTextMap = {
                            default: '默认',
                            unknown: '未知',
                            passthrough: '透传',
                            normalization_disabled: '未启用归一化'
                        };
                        const ruleText = ruleTextMap[l.ua_rule] || l.ua_rule || '-';
                        const familyText = l.ua_family || l.cache_bucket || '-';
                        
                        html += `
                            <tr>
                                <td class="text-sm">${l.time ? new Date(l.time).toLocaleString() : '-'}</td>
                                <td class="text-sm"><strong>${escapeHtml(keyDisplay)}</strong></td>
                                <td class="text-sm"><span class="code-box">${escapeHtml(l.client_ip || '-')}</span></td>
                                <td class="text-sm"><span class="code-box log-ua" title="${escapeHtml(l.user_agent || '')}">${escapeHtml(l.user_agent || '-')}</span></td>
                                <td class="text-sm">${escapeHtml(ruleText)}</td>
                                <td class="text-sm">${escapeHtml(l.ua_variant || '-')}</td>
                                <td class="text-sm">${escapeHtml(familyText)}</td>
                                <td>${cacheHit}</td>
                                <td>${statusBadge}</td>
                                <td class="text-sm">${escapeHtml(l.message || '-')}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="dash-card-footer" style="justify-content: center;">
                            <div class="pagination">
                                <button class="btn btn-secondary btn-sm" onclick="loadLogPage(${page - 1})" ${page <= 1 ? 'disabled' : ''}>上一页</button>
                                <span class="text-sm text-muted">第 ${data.page || 1} / ${data.total_pages || 1} 页，共 ${data.total_count || 0} 条</span>
                                <button class="btn btn-secondary btn-sm" onclick="loadLogPage(${page + 1})" ${page >= (data.total_pages || 1) ? 'disabled' : ''}>下一页</button>
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function renderSettings() {
            const content = $('#content-area');
            content.innerHTML = '<div class="text-muted">加载中...</div>';
            const canWriteSettings = hasPermission(PERM.SETTINGS_WRITE);
            try {
                const data = await api('/settings');
                const config = data.global_config || {};
                const uaNorm = config.ua_normalization || {};
                const rulesJson = uaNorm.rules ? JSON.stringify(uaNorm.rules, null, 2) : '[]';
                content.innerHTML = `
                    <div class="dash-card">
                        <div class="dash-card-header">
                            <div class="dash-card-title">Global Configuration</div>
                        </div>
                        <div class="dash-card-body">
                            <div class="form-group">
                                <label class="form-label">日志保留天数</label>
                                <input type="number" class="input" id="setting-retention" value="${config.log_retention_days || 0}" min="0" style="max-width: 200px;">
                                <div class="form-hint">设置为0表示不自动清理。</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">活跃UA窗口（天）</label>
                                <input type="number" class="input" id="setting-active-ua-days" value="${config.active_ua_days || 30}" min="1" style="max-width: 200px;">
                                <div class="form-hint">强制缓存模式会刷新最近该天数内出现过的UA缓存变体。</div>
                            </div>
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
                            <div class="form-group">
                                <label class="form-label flex items-center gap-2">
                                    <input type="checkbox" id="setting-ua-enabled" ${uaNorm.enabled ? 'checked' : ''}>
                                    启用UA归一化
                                </label>
                                <div class="form-hint">启用后将根据规则对User-Agent进行归一化处理，减少缓存变体数量。</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label flex items-center gap-2">
                                    <input type="checkbox" id="setting-ua-unknown-passthrough" ${uaNorm.unknown_passthrough ? 'checked' : ''}>
                                    未知UA透传
                                </label>
                                <div class="form-hint">不匹配任何规则的UA将原样透传，否则使用默认归一化结果。</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">归一化规则</label>
                                <textarea class="input" id="setting-ua-rules" rows="10" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.85rem;">${escapeHtml(rulesJson)}</textarea>
                                <div class="form-hint">JSON格式的规则数组。每条规则需要 canonical_class, bucket_key, 以及 all_contains 或 any_contains。</div>
                                <div id="ua-rules-error" class="text-danger text-sm mt-4 hidden"></div>
                                <input type="file" id="ua-rules-import-file" accept="application/json,.json" class="hidden">
                            </div>
                        </div>
                        <div class="dash-card-footer">
                            <div class="dash-actions">
                                <button class="btn btn-secondary" id="export-rules-btn">导出规则</button>
                                <button class="btn btn-secondary" id="import-rules-btn" ${canWriteSettings ? '' : 'disabled'}>导入规则</button>
                                <button class="btn btn-secondary" id="validate-rules-btn" ${canWriteSettings ? '' : 'disabled'}>验证规则</button>
                                <button class="btn btn-primary" id="save-settings-btn" ${canWriteSettings ? '' : 'disabled'}>保存设置</button>
                            </div>
                        </div>
                    </div>
                `;

                $('#export-rules-btn').onclick = exportUARules;
                if (canWriteSettings) {
                    $('#import-rules-btn').onclick = () => {
                        const fileInput = $('#ua-rules-import-file');
                        if (!fileInput) return;
                        fileInput.value = '';
                        fileInput.click();
                    };
                }
                const importInput = $('#ua-rules-import-file');
                if (importInput) {
                    importInput.onchange = async () => {
                        if (!canWriteSettings) return;
                        const file = importInput.files && importInput.files[0];
                        if (!file) return;
                        await importUARulesFromFile(file);
                    };
                }

                $('#validate-rules-btn').onclick = () => {
                    if (!canWriteSettings) return;
                    const rulesText = $('#setting-ua-rules').value.trim();
                    const errorEl = $('#ua-rules-error');
                    if (!rulesText) {
                        errorEl.textContent = '';
                        errorEl.classList.add('hidden');
                        showToast('规则为空，无需验证', 'info');
                        return;
                    }
                    try {
                        const rules = JSON.parse(rulesText);
                        if (!Array.isArray(rules)) {
                            throw new Error('规则必须是数组');
                        }
                        // Validate each rule
                        for (let i = 0; i < rules.length; i++) {
                            const r = rules[i];
                            if (!r.canonical_class) {
                                throw new Error(`规则[${i}]: missing canonical_class`);
                            }
                            if (!r.bucket_key) {
                                throw new Error(`规则[${i}]: missing bucket_key`);
                            }
                            if ((!r.all_contains || r.all_contains.length === 0) && (!r.any_contains || r.any_contains.length === 0)) {
                                throw new Error(`规则[${i}]: 至少需要 all_contains 或 any_contains`);
                            }
                        }
                        errorEl.textContent = '';
                        errorEl.classList.add('hidden');
                        showToast('规则验证通过', 'success');
                    } catch (e) {
                        errorEl.textContent = '验证失败: ' + e.message;
                        errorEl.classList.remove('hidden');
                        showToast(e.message, 'error');
                    }
                };
                $('#save-settings-btn').onclick = async () => {
                    if (!canWriteSettings) {
                        showToast('当前账号无设置修改权限', 'error');
                        return;
                    }
                    try {
                        const days = parseInt($('#setting-retention').value) || 0;
                        const activeUaDays = parseInt($('#setting-active-ua-days').value) || 30;
                        // Parse and validate UA normalization rules
                        const uaEnabled = $('#setting-ua-enabled').checked;
                        const uaUnknownPassthrough = $('#setting-ua-unknown-passthrough').checked;
                        const rulesText = $('#setting-ua-rules').value.trim();
                        let rules = [];
                        
                        if (rulesText) {
                            try {
                                rules = JSON.parse(rulesText);
                                if (!Array.isArray(rules)) {
                                    throw new Error('规则必须是数组');
                                }
                                // Validate each rule structure
                                for (let i = 0; i < rules.length; i++) {
                                    const r = rules[i];
                                    if (!r.canonical_class) {
                                        throw new Error(`规则[${i}]: missing canonical_class`);
                                    }
                                    if (!r.bucket_key) {
                                        throw new Error(`规则[${i}]: missing bucket_key`);
                                    }
                                    if ((!r.all_contains || r.all_contains.length === 0) && (!r.any_contains || r.any_contains.length === 0)) {
                                        throw new Error(`规则[${i}]: 至少需要 all_contains 或 any_contains`);
                                    }
                                }
                            } catch (e) {
                                throw new Error('UA规则JSON格式错误: ' + e.message);
                            }
                        }

                        const payload = {
                            log_retention_days: days,
                            active_ua_days: activeUaDays,
                            ua_normalization: {
                                enabled: uaEnabled,
                                unknown_passthrough: uaUnknownPassthrough,
                                rules: rules
                            }
                        };

                        await api('/settings', { method: 'PUT', body: JSON.stringify(payload) });
                        showToast('设置已保存', 'success');
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                };
            } catch (e) {
                content.innerHTML = '<div class="text-danger">加载失败: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function exportUARules() {
            try {
                const res = await fetch('/admin/api/settings/ua-rules/export', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        showLogin();
                        return;
                    }
                    let errorText = '导出失败';
                    try {
                        const errData = await res.json();
                        errorText = errData.error || errorText;
                    } catch (e) {}
                    throw new Error(errorText);
                }

                const blob = await res.blob();
                const disposition = res.headers.get('Content-Disposition') || '';
                const match = disposition.match(/filename="?([^";]+)"?/i);
                const filename = (match && match[1]) ? match[1] : 'ua-rules-export.json';

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showToast('规则导出成功', 'success');
            } catch (e) {
                showToast(e.message || '导出失败', 'error');
            }
        }

        async function importUARulesFromFile(file) {
            if (!hasPermission(PERM.SETTINGS_WRITE)) {
                showToast('当前账号无设置修改权限', 'error');
                return;
            }
            if (!file) return;
            try {
                const text = await file.text();
                const payload = JSON.parse(text);
                if (!payload || !Array.isArray(payload.rules)) {
                    throw new Error('规则文件必须包含 rules 数组');
                }
                const result = await api('/settings/ua-rules/import', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showToast(`规则导入成功，共 ${result.imported || 0} 条`, 'success');
                renderSettings();
            } catch (e) {
                showToast(e.message || '导入失败', 'error');
            }
        }

        function showModal(title, bodyHtml, onConfirm) {
            const container = $('#modal-container');
            container.innerHTML = `
                <div class="modal-overlay" id="modal-overlay">
                    <div class="modal">
                        <div class="modal-header">
                            <span>${escapeHtml(title)}</span>
                            <button class="btn btn-secondary btn-sm" id="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">${bodyHtml}</div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">取消</button>
                            <button class="btn btn-primary" id="modal-confirm">确定</button>
                        </div>
                    </div>
                </div>
            `;

            const close = () => {
                container.innerHTML = '';
            };
            $('#modal-close').onclick = close;
            $('#modal-cancel').onclick = close;
            $('#modal-overlay').onclick = (e) => { if (e.target.id === 'modal-overlay') close(); };

            $('#modal-confirm').onclick = async () => {
                const btn = $('#modal-confirm');
                btn.disabled = true;
                btn.textContent = '处理中...';
                try {
                    const result = await onConfirm();
                    if (result) close();
                } catch (e) {
                    showToast(e.message, 'error');
                } finally {
                    if ($('#modal-confirm')) {
                        btn.disabled = false;
                        btn.textContent = '确定';
                    }
                }
            };
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        async function login() {
            const username = ($('#login-username')?.value || '').trim();
            const password = $('#login-password').value;
            const errorEl = $('#login-error');
            errorEl.textContent = '';

            try {
                const data = await api('/login', { method: 'POST', body: JSON.stringify({ username, password }) });
                if (data.user) {
                    setCurrentUser(data.user);
                }
                showApp();
            } catch (e) {
                errorEl.textContent = e.message || '登录失败';
            }
        }

        async function logout() {
            try {
                await api('/logout', { method: 'POST' });
            } catch (e) {}
            showLogin();
        }

        async function checkSession() {
            try {
                const data = await api('/status');
                if (data.current_user) {
                    setCurrentUser(data.current_user);
                }
                showApp();
            } catch (e) {
                showLogin();
            }
        }

        function init() {
            $('#login-form').onsubmit = (e) => { e.preventDefault(); login(); };
            $('#logout-btn').onclick = logout;

            $$('.nav-item[data-view]').forEach(item => {
                item.onclick = () => {
                    navigate(item.dataset.view);
                    if (window.innerWidth <= 768) {
                        $('#sidebar').classList.remove('open');
                    }
                };
            });

            const menuBtn = $('#menu-toggle');
            if (window.innerWidth <= 768) menuBtn.style.display = 'block';
            menuBtn.onclick = () => $('#sidebar').classList.toggle('open');

            checkSession();
        }

        init();
    </script>
</body>
</html>
